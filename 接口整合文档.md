# è½»ç‡ƒå¥åº·ç®¡ç†ç³»ç»Ÿ - ç»Ÿä¸€æ¥å£æ–‡æ¡£

> æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•åœ¨å‰ç«¯é¡µé¢ä¸­ç»Ÿä¸€è°ƒç”¨åç«¯æ¥å£
> 
> **é‡è¦åŸåˆ™**ï¼šæ‰€æœ‰äº‘å‡½æ•°è°ƒç”¨å¿…é¡»é€šè¿‡ `utils/cloudApi.js` è¿›è¡Œï¼Œç¦æ­¢ç›´æ¥è°ƒç”¨ `wx.cloud.callFunction()`

---

## ğŸ“‹ ç›®å½•

- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [å¥åº·æœåŠ¡æ¥å£ (HealthService)](#å¥åº·æœåŠ¡æ¥å£-healthservice)
- [é¥®é£ŸæœåŠ¡æ¥å£ (DietService)](#é¥®é£ŸæœåŠ¡æ¥å£-dietservice)
- [AI æœåŠ¡æ¥å£ (QwenAI)](#ai-æœåŠ¡æ¥å£-qwenai)
- [é£Ÿè°±æ¨èæ¥å£](#é£Ÿè°±æ¨èæ¥å£)
- [å·¥å…·å‡½æ•°](#å·¥å…·å‡½æ•°)
- [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¼•å…¥æ¥å£æ¨¡å—

```javascript
// åœ¨é¡µé¢ JS æ–‡ä»¶é¡¶éƒ¨å¼•å…¥
import * as api from '../../utils/cloudApi.js';
// æˆ–ä½¿ç”¨ require
const api = require('../../utils/cloudApi.js');
```

### 2. è°ƒç”¨æ¥å£

```javascript
// ç¤ºä¾‹ï¼šè·å–ç”¨æˆ·ä¿¡æ¯
async loadProfile() {
  try {
    const res = await api.getProfile();
    if (res.result?.success) {
      this.setData({ profile: res.result.data });
    }
  } catch (error) {
    api.handleError(error, 'åŠ è½½å¤±è´¥');
  }
}
```

### 3. å“åº”æ ¼å¼

æ‰€æœ‰æ¥å£ç»Ÿä¸€è¿”å›æ ¼å¼ï¼š

```javascript
{
  result: {
    success: true,        // æ˜¯å¦æˆåŠŸ
    data: {},            // è¿”å›æ•°æ®
    error: ''            // é”™è¯¯ä¿¡æ¯ï¼ˆå¤±è´¥æ—¶ï¼‰
  }
}
```

---

## ğŸ’Š å¥åº·æœåŠ¡æ¥å£ (HealthService)

### updateProfile - æ›´æ–°ç”¨æˆ·ä¿¡æ¯

```javascript
api.updateProfile({
  gender: 'male',        // 'male' | 'female'
  age: 25,
  height: 170,          // cm
  weight: 70,           // kg
  targetWeight: 65,     // kg
  goal: 'å‡è„‚',         // 'å‡è„‚' | 'å¢è‚Œ' | 'ä¿æŒ'
  activityLevel: 1.375  // 1.2 ~ 1.9
})
```

**ä½¿ç”¨åœºæ™¯**ï¼šä¸ªäººä¿¡æ¯é¡µé¢ã€é¦–æ¬¡è®¾ç½®

---

### getProfile - è·å–ç”¨æˆ·ä¿¡æ¯

```javascript
const res = await api.getProfile();
// res.result.data = { gender, age, height, weight, bmi, bmr, tdee, ... }
```

**ä½¿ç”¨åœºæ™¯**ï¼šé¦–é¡µã€ä¸ªäººä¸­å¿ƒã€ä»»ä½•éœ€è¦ç”¨æˆ·ä¿¡æ¯çš„é¡µé¢

---

### generatePlan - ç”Ÿæˆå‡é‡è®¡åˆ’

```javascript
api.generatePlan(
  -5,    // ç›®æ ‡ä½“é‡å˜åŒ–(kg)ï¼Œè´Ÿæ•°ä¸ºå‡é‡ï¼Œæ­£æ•°ä¸ºå¢é‡
  90     // æ€»å¤©æ•°
)
```

**è¿”å›æ•°æ®**ï¼š

```javascript
{
  planId: 'xxx',
  targetWeightChange: -5,
  totalDays: 90,
  dailyCalorieDeficit: -500,  // æ¯æ—¥çƒ­é‡å·®
  expectedEndDate: '2025-03-10',
  ...
}
```

**ä½¿ç”¨åœºæ™¯**ï¼šè®¡åˆ’ç”Ÿæˆé¡µé¢

---

### adjustPlan - åŠ¨æ€è°ƒæ•´è®¡åˆ’

```javascript
api.adjustPlan(
  '2025-12-09',  // æ—¥æœŸ
  -300           // å®é™…çƒ­é‡å·®
)
```

**ä½¿ç”¨åœºæ™¯**ï¼šè®¡åˆ’è¯¦æƒ…é¡µé¢ã€æ¯æ—¥æŠ¥å‘Š

---

### evaluateDaily - æ¯æ—¥è¯„ä»·

```javascript
api.evaluateDaily('2025-12-09')  // æ—¥æœŸå¯é€‰ï¼Œé»˜è®¤ä»Šæ—¥
```

**è¿”å›æ•°æ®**ï¼š

```javascript
{
  date: '2025-12-09',
  status: 'success',      // 'success' | 'warning' | 'danger'
  score: 85,              // è¥å…»è¯„åˆ† 0-100
  calorieIntake: 1800,
  calorieGoal: 2000,
  calorieDeficit: -200,
  suggestions: [...],
  ...
}
```

**ä½¿ç”¨åœºæ™¯**ï¼šæ¯æ—¥æŠ¥å‘Šé¡µé¢

---

### recommendExercise - æ¨èè¿åŠ¨

```javascript
const res = await api.recommendExercise();
// res.result.data = [{ name, duration, calories, met, ... }]
```

**ä½¿ç”¨åœºæ™¯**ï¼šè¿åŠ¨æ¨èé¡µé¢

---

### logExercise - è®°å½•è¿åŠ¨

```javascript
api.logExercise({
  name: 'æ…¢è·‘',
  duration: 30,        // åˆ†é’Ÿ
  calories: 300,       // æ¶ˆè€—çƒ­é‡
  date: '2025-12-09'   // å¯é€‰ï¼Œé»˜è®¤ä»Šæ—¥
})
```

**ä½¿ç”¨åœºæ™¯**ï¼šè¿åŠ¨è®°å½•é¡µé¢

---

## ğŸ½ï¸ é¥®é£ŸæœåŠ¡æ¥å£ (DietService)

### quickSearchFood - å¿«é€Ÿæœç´¢é£Ÿç‰©

ç”¨äºå®æ—¶æœç´¢å»ºè®®ï¼Œä»…æŸ¥è¯¢æœ¬åœ°æ•°æ®åº“ï¼Œé€Ÿåº¦å¿«ã€‚

```javascript
api.quickSearchFood('é¸¡èƒ¸è‚‰', 10)  // å…³é”®è¯, è¿”å›æ•°é‡
```

**ä½¿ç”¨åœºæ™¯**ï¼šæœç´¢æ¡†å®æ—¶å»ºè®®

---

### searchFood - å®Œæ•´æœç´¢é£Ÿç‰©

ä¸‰å±‚æ¶æ„æœç´¢ï¼šæœ¬åœ°æ•°æ®åº“ â†’ AIæ‰©å±• â†’ ç¬¬ä¸‰æ–¹API

```javascript
api.searchFood(
  'é¸¡èƒ¸è‚‰',  // å…³é”®è¯
  20,        // è¿”å›æ•°é‡
  'full'     // 'quick' | 'full'
)
```

**è¿”å›æ•°æ®**ï¼š

```javascript
[
  {
    foodId: 'xxx',
    name: 'é¸¡èƒ¸è‚‰',
    calories: 133,      // æ¯100g
    protein: 24,
    carbs: 2,
    fat: 5,
    source: 'FoodDB',  // 'FoodDB' | 'AI' | 'UserDishes'
    ...
  }
]
```

**ä½¿ç”¨åœºæ™¯**ï¼šé£Ÿç‰©æœç´¢é¡µé¢

---

### recognizeFood - æ‹ç…§è¯†åˆ«é£Ÿç‰©

```javascript
api.recognizeFood({
  fileID: 'cloud://xxx'  // äº‘å­˜å‚¨æ–‡ä»¶ID
  // æˆ–
  // imageData: 'base64...'
})
```

**è¿”å›æ•°æ®**ï¼š

```javascript
{
  recognizedFoods: [
    { name: 'ç±³é¥­', confidence: 0.95 },
    { name: 'è¥¿çº¢æŸ¿ç‚’è›‹', confidence: 0.88 }
  ],
  searchResults: [
    { foodId, name, calories, protein, carbs, fat, ... }
  ]
}
```

**ä½¿ç”¨åœºæ™¯**ï¼šæ‹ç…§è¯†åˆ«é¡µé¢

---

### addDietLog - æ·»åŠ é¥®é£Ÿè®°å½•

```javascript
api.addDietLog({
  foodId: 'xxx',
  foodName: 'é¸¡èƒ¸è‚‰',
  amount: 150,           // å…‹æ•°
  unit: 'g',
  calories: 200,
  protein: 36,
  carbs: 3,
  fat: 7.5,
  mealType: 'lunch',     // 'breakfast' | 'lunch' | 'dinner' | 'snack'
  date: '2025-12-09'     // å¯é€‰ï¼Œé»˜è®¤ä»Šæ—¥
})
```

**ä½¿ç”¨åœºæ™¯**ï¼šæ‰€æœ‰æ·»åŠ é¥®é£Ÿè®°å½•çš„åœ°æ–¹

---

### getDietLogs - è·å–æŸæ—¥é¥®é£Ÿè®°å½•

```javascript
const res = await api.getDietLogs('2025-12-09');  // æ—¥æœŸå¯é€‰
// res.result.data = {
//   records: [...],
//   summary: { totalCalories, totalProtein, totalCarbs, totalFat }
// }
```

**ä½¿ç”¨åœºæ™¯**ï¼šé¥®é£Ÿè®°å½•ä¸»é¡µã€æ¯æ—¥æŠ¥å‘Š

---

### getDietLogsByRange - è·å–æ—¥æœŸèŒƒå›´å†…çš„è®°å½•

```javascript
api.getDietLogsByRange('2025-12-01', '2025-12-09')
```

**ä½¿ç”¨åœºæ™¯**ï¼šæ•°æ®ç»Ÿè®¡é¡µé¢

---

### updateDietLog - æ›´æ–°é¥®é£Ÿè®°å½•

```javascript
api.updateDietLog('logId', {
  amount: 200,
  calories: 266
})
```

**ä½¿ç”¨åœºæ™¯**ï¼šç¼–è¾‘é¥®é£Ÿè®°å½•

---

### deleteDietLog - åˆ é™¤é¥®é£Ÿè®°å½•

```javascript
api.deleteDietLog('logId')
```

**ä½¿ç”¨åœºæ™¯**ï¼šé¥®é£Ÿè®°å½•åˆ—è¡¨

---

### getFrequentFoods - è·å–ç”¨æˆ·å¸¸ç”¨é£Ÿç‰©

```javascript
const res = await api.getFrequentFoods(20);
// è¿”å›æŒ‰ä½¿ç”¨é¢‘ç‡æ’åºçš„é£Ÿç‰©åˆ—è¡¨
```

**ä½¿ç”¨åœºæ™¯**ï¼šé£Ÿç‰©æœç´¢é¡µé¢çš„"å¸¸ç”¨é£Ÿç‰©"æ¨¡å—

---

### è‡ªå®šä¹‰èœå“ç®¡ç†

#### addCustomDish - æ·»åŠ è‡ªå®šä¹‰èœå“

```javascript
api.addCustomDish({
  name: 'æˆ‘çš„å¥åº·æ²™æ‹‰',
  ingredients: ['ç”Ÿèœ', 'ç•ªèŒ„', 'é»„ç“œ', 'é¸¡èƒ¸è‚‰'],
  calories: 250,
  protein: 30,
  carbs: 15,
  fat: 8,
  description: 'ä½è„‚é«˜è›‹ç™½'
})
```

#### getUserDishes - è·å–ç”¨æˆ·è‡ªå®šä¹‰èœå“

```javascript
const res = await api.getUserDishes(50);
```

#### updateCustomDish - æ›´æ–°è‡ªå®šä¹‰èœå“

```javascript
api.updateCustomDish('dishId', { calories: 260 })
```

#### deleteCustomDish - åˆ é™¤è‡ªå®šä¹‰èœå“

```javascript
api.deleteCustomDish('dishId')
```

**ä½¿ç”¨åœºæ™¯**ï¼šè‡ªå®šä¹‰èœå“ç®¡ç†é¡µé¢

---

### calculateCalories - è®¡ç®—é£Ÿç‰©çƒ­é‡

æ ¹æ®é£Ÿç‰©IDã€æ¥æºå’Œä»½é‡è®¡ç®—çƒ­é‡åŠè¥å…»ç´ ã€‚

```javascript
api.calculateCalories(
  'foodId',
  'FoodDB',    // 'FoodDB' | 'UserDishes'
  150,         // æ•°é‡
  'g'          // å•ä½
)
```

**ä½¿ç”¨åœºæ™¯**ï¼šä»½é‡è°ƒæ•´æ—¶å®æ—¶è®¡ç®—

---

## ğŸ¤– AI æœåŠ¡æ¥å£ (QwenAI)

### analyzeAndRecommend - AIåˆ†æå¹¶ç”Ÿæˆå»ºè®®

```javascript
api.analyzeAndRecommend(
  userData,        // ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
  dietRecords,     // é¥®é£Ÿè®°å½•æ•°ç»„
  nutritionGap     // è¥å…»ç¼ºå£æ•°æ®
)
```

**è¿”å›æ•°æ®**ï¼š

```javascript
{
  overall_assessment: 'æ‚¨çš„é¥®é£Ÿ...',
  nutrition_score: 85,
  suggestions: [
    {
      type: 'protein',         // 'protein' | 'carbs' | 'fat' | 'calories' | 'general'
      severity: 'warning',     // 'success' | 'info' | 'warning' | 'error'
      icon: 'ğŸ’ª',
      title: 'è›‹ç™½è´¨æ‘„å…¥ä¸è¶³',
      message: 'å»ºè®®å¢åŠ ...',
      priority: 1
    }
  ],
  recommended_food_types: ['é«˜è›‹ç™½é£Ÿç‰©', 'è”¬èœ'],
  cooking_methods: ['è’¸', 'ç…®', 'çƒ¤'],
  food_tags_priority: ['é«˜è›‹ç™½', 'ä½å¡', 'ä½è„‚']
}
```

**ä½¿ç”¨åœºæ™¯**ï¼šAIå»ºè®®é¡µé¢ã€æ¯æ—¥æŠ¥å‘Š

---

### generateRecipeReason - ç”Ÿæˆé£Ÿè°±æ¨èç†ç”±

```javascript
api.generateRecipeReason(
  recipe,          // é£Ÿè°±ä¿¡æ¯
  userData,        // ç”¨æˆ·ä¿¡æ¯
  nutritionGap     // è¥å…»ç¼ºå£
)
```

**è¿”å›æ•°æ®**ï¼šå­—ç¬¦ä¸²ï¼Œä¸€å¥è¯æ¨èç†ç”±

**ä½¿ç”¨åœºæ™¯**ï¼šé£Ÿè°±æ¨èåˆ—è¡¨

---

### customPrompt - è‡ªå®šä¹‰æç¤ºè¯

```javascript
api.customPrompt('è¯·å¸®æˆ‘åˆ†æä»Šå¤©çš„é¥®é£Ÿ...')
```

**ä½¿ç”¨åœºæ™¯**ï¼šAIèŠå¤©ã€è‡ªå®šä¹‰åˆ†æ

---

## ğŸ¯ é£Ÿè°±æ¨èæ¥å£

### getRecommendedRecipes - è·å–æ¨èé£Ÿè°±

```javascript
api.getRecommendedRecipes({
  type: 'ai',      // 'goal' | 'preference' | 'ai'
  limit: 10,       // è¿”å›æ•°é‡
  days: 7          // åˆ†æå¤©æ•°ï¼ˆAIæ¨èæ—¶ä½¿ç”¨ï¼‰
})
```

**æ¨èç±»å‹è¯´æ˜**ï¼š
- `goal`: åŸºäºç”¨æˆ·ç›®æ ‡ï¼ˆå‡è„‚/å¢è‚Œ/ä¿æŒï¼‰
- `preference`: åŸºäºç”¨æˆ·åå¥½å’Œè¿‡æ•æº
- `ai`: æ™ºèƒ½æ¨èï¼ˆç»“åˆç›®æ ‡ã€åå¥½ã€è¥å…»ç¼ºå£ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼šé£Ÿè°±æ¨èé¡µé¢

---

### analyzeNutritionGap - åˆ†æè¥å…»ç¼ºå£

```javascript
const res = await api.analyzeNutritionGap(7);  // åˆ†ææœ€è¿‘7å¤©
// res.result.data = {
//   days: 7,
//   proteinDeficit: 20,   // è›‹ç™½è´¨ä¸è¶³
//   proteinExcess: 0,     // è›‹ç™½è´¨è¶…æ ‡
//   carbsDeficit: 0,
//   carbsExcess: 30,
//   fatDeficit: 0,
//   fatExcess: 15,
//   caloriesDeficit: 0,
//   caloriesExcess: 500
// }
```

**ä½¿ç”¨åœºæ™¯**ï¼šAIå»ºè®®é¡µé¢ã€æ•°æ®ç»Ÿè®¡é¡µé¢

---

### getFavoriteIngredients - è·å–ç”¨æˆ·å¸¸åƒé£Ÿæ

```javascript
const res = await api.getFavoriteIngredients(10);
// è¿”å›æŒ‰ä½¿ç”¨é¢‘ç‡æ’åºçš„é£Ÿæåˆ—è¡¨
```

**ä½¿ç”¨åœºæ™¯**ï¼šä¸ªæ€§åŒ–æ¨è

---

### getRecipeDetail - è·å–é£Ÿè°±è¯¦æƒ…

```javascript
const res = await api.getRecipeDetail('recipeId');
```

**ä½¿ç”¨åœºæ™¯**ï¼šé£Ÿè°±è¯¦æƒ…é¡µé¢

---

### æ”¶è—ç®¡ç†

#### favoriteRecipe - æ”¶è—é£Ÿè°±

```javascript
api.favoriteRecipe('recipeId')
```

#### unfavoriteRecipe - å–æ¶ˆæ”¶è—

```javascript
api.unfavoriteRecipe('recipeId')
```

#### getFavoriteRecipes - è·å–æ”¶è—çš„é£Ÿè°±

```javascript
const res = await api.getFavoriteRecipes(50);
```

**ä½¿ç”¨åœºæ™¯**ï¼šæˆ‘çš„æ”¶è—é¡µé¢

---

## ğŸ› ï¸ å·¥å…·å‡½æ•°

### handleError - ç»Ÿä¸€é”™è¯¯å¤„ç†

```javascript
try {
  const res = await api.getProfile();
} catch (error) {
  api.handleError(error, 'åŠ è½½å¤±è´¥');  // è‡ªåŠ¨æ˜¾ç¤º Toast
}
```

---

### showSuccess - ç»Ÿä¸€æˆåŠŸæç¤º

```javascript
api.showSuccess('ä¿å­˜æˆåŠŸ', 2000);  // æ¶ˆæ¯, æŒç»­æ—¶é—´(ms)
```

---

### getTodayString - è·å–ä»Šæ—¥æ—¥æœŸå­—ç¬¦ä¸²

```javascript
const today = api.getTodayString();  // '2025-12-09'
```

---

### formatDate - æ—¥æœŸæ ¼å¼åŒ–

```javascript
const dateStr = api.formatDate(new Date());  // '2025-12-09'
```

---

### getDaysBetween - è®¡ç®—ä¸¤ä¸ªæ—¥æœŸä¹‹é—´çš„å¤©æ•°

```javascript
const days = api.getDaysBetween('2025-12-01', '2025-12-09');  // 8
```

---

## âš ï¸ é”™è¯¯å¤„ç†

### æ ‡å‡†é”™è¯¯å¤„ç†æ¨¡å¼

```javascript
async loadData() {
  try {
    wx.showLoading({ title: 'åŠ è½½ä¸­...' });
    
    const res = await api.getProfile();
    
    if (res.result?.success) {
      this.setData({ profile: res.result.data });
      wx.hideLoading();
    } else {
      throw new Error(res.result?.error || 'åŠ è½½å¤±è´¥');
    }
  } catch (error) {
    wx.hideLoading();
    api.handleError(error, 'åŠ è½½å¤±è´¥');
  }
}
```

### å¤šä¸ªæ¥å£å¹¶å‘è°ƒç”¨

```javascript
async loadAllData() {
  try {
    wx.showLoading({ title: 'åŠ è½½ä¸­...' });
    
    const [profileRes, dietRes, exerciseRes] = await Promise.all([
      api.getProfile(),
      api.getDietLogs(),
      api.recommendExercise()
    ]);
    
    this.setData({
      profile: profileRes.result?.data,
      dietSummary: dietRes.result?.data?.summary,
      exercises: exerciseRes.result?.data
    });
    
    wx.hideLoading();
  } catch (error) {
    wx.hideLoading();
    api.handleError(error);
  }
}
```

---

## ğŸ“– æœ€ä½³å®è·µ

### 1. ç»Ÿä¸€å¼•å…¥æ–¹å¼

åœ¨é¡µé¢é¡¶éƒ¨ç»Ÿä¸€å¼•å…¥ï¼š

```javascript
import * as api from '../../utils/cloudApi.js';
import * as calc from '../../utils/calculator.js';
```

### 2. åŠ è½½çŠ¶æ€ç®¡ç†

```javascript
Page({
  data: {
    loading: false
  },
  
  async loadData() {
    if (this.data.loading) return;  // é˜²æ­¢é‡å¤è¯·æ±‚
    
    this.setData({ loading: true });
    wx.showLoading({ title: 'åŠ è½½ä¸­...' });
    
    try {
      const res = await api.getProfile();
      // å¤„ç†æ•°æ®...
    } catch (error) {
      api.handleError(error);
    } finally {
      this.setData({ loading: false });
      wx.hideLoading();
    }
  }
})
```

### 3. æ•°æ®éªŒè¯

åœ¨è°ƒç”¨æ¥å£å‰è¿›è¡Œæ•°æ®éªŒè¯ï¼š

```javascript
import * as calc from '../../utils/calculator.js';

async onSave() {
  const { age, height, weight } = this.data.profile;
  
  // ä½¿ç”¨ calculator.js ä¸­çš„éªŒè¯å‡½æ•°
  if (!calc.validateInput.age(age)) {
    wx.showToast({ title: 'å¹´é¾„åº”åœ¨18-80å²ä¹‹é—´', icon: 'none' });
    return;
  }
  
  if (!calc.validateInput.height(height)) {
    wx.showToast({ title: 'èº«é«˜åº”åœ¨100-250cmä¹‹é—´', icon: 'none' });
    return;
  }
  
  // éªŒè¯é€šè¿‡ï¼Œè°ƒç”¨æ¥å£
  await api.updateProfile(this.data.profile);
}
```

### 4. å“åº”å¼æ›´æ–°

```javascript
async onDelete(e) {
  const { logId } = e.currentTarget.dataset;
  
  const res = await wx.showModal({
    title: 'ç¡®è®¤åˆ é™¤',
    content: 'ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ'
  });
  
  if (res.confirm) {
    try {
      await api.deleteDietLog(logId);
      api.showSuccess('åˆ é™¤æˆåŠŸ');
      
      // é‡æ–°åŠ è½½æ•°æ®
      this.loadData();
    } catch (error) {
      api.handleError(error);
    }
  }
}
```

### 5. ç¼“å­˜ç­–ç•¥

å¯¹äºä¸ç»å¸¸å˜åŒ–çš„æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ç¼“å­˜ï¼š

```javascript
async loadProfile() {
  // å…ˆä»ç¼“å­˜è¯»å–
  const cachedProfile = wx.getStorageSync('profile');
  if (cachedProfile) {
    this.setData({ profile: cachedProfile });
  }
  
  // åå°æ›´æ–°
  try {
    const res = await api.getProfile();
    if (res.result?.success) {
      const profile = res.result.data;
      this.setData({ profile });
      wx.setStorageSync('profile', profile);
    }
  } catch (error) {
    if (!cachedProfile) {
      api.handleError(error);
    }
  }
}
```

---

## ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

### 1. API Key ä¿æŠ¤

- âŒ **ç¦æ­¢**åœ¨å‰ç«¯ä»£ç ä¸­ç›´æ¥ä½¿ç”¨ API Key
- âœ… **æ‰€æœ‰** AI è°ƒç”¨å¿…é¡»é€šè¿‡äº‘å‡½æ•°è¿›è¡Œ
- âœ… API Key åªå­˜å‚¨åœ¨äº‘å‡½æ•°ç¯å¢ƒå˜é‡ä¸­

### 2. æ•°æ®éªŒè¯

- å‰ç«¯éªŒè¯ï¼šæå‡ç”¨æˆ·ä½“éªŒ
- åç«¯éªŒè¯ï¼šä¿è¯æ•°æ®å®‰å…¨
- åŒé‡éªŒè¯ï¼šå¿…ä¸å¯å°‘

### 3. æƒé™æ§åˆ¶

```javascript
// äº‘å‡½æ•°ä¼šè‡ªåŠ¨éªŒè¯ç”¨æˆ·èº«ä»½
// å‰ç«¯åªéœ€æ­£å¸¸è°ƒç”¨å³å¯
const res = await api.getProfile();
// äº‘å‡½æ•°ä¼šç¡®ä¿åªè¿”å›å½“å‰ç”¨æˆ·çš„æ•°æ®
```

---

## ğŸ“Š æ¥å£è°ƒç”¨ç¤ºä¾‹

### å®Œæ•´çš„ä¸ªäººä¿¡æ¯é¡µé¢ç¤ºä¾‹

```javascript
// pages/profile/index.js
import * as api from '../../utils/cloudApi.js';
import * as calc from '../../utils/calculator.js';

Page({
  data: {
    profile: {},
    bmi: 0,
    bmr: 0,
    tdee: 0,
    loading: false
  },

  onLoad() {
    this.loadProfile();
  },

  async loadProfile() {
    try {
      wx.showLoading({ title: 'åŠ è½½ä¸­...' });
      const res = await api.getProfile();
      
      if (res.result?.success) {
        const profile = res.result.data;
        this.setData({ profile });
        this.calculateHealth();
      }
      
      wx.hideLoading();
    } catch (error) {
      wx.hideLoading();
      api.handleError(error, 'åŠ è½½å¤±è´¥');
    }
  },

  calculateHealth() {
    const { weight, height, age, gender, activityLevel } = this.data.profile;
    
    const bmi = calc.calculateBMI(weight, height);
    const bmr = calc.calculateBMR(weight, height, age, gender);
    const tdee = calc.calculateTDEE(bmr, activityLevel);
    
    this.setData({ bmi, bmr, tdee });
  },

  async onSave() {
    if (!this.validateInput()) return;
    
    try {
      this.setData({ loading: true });
      wx.showLoading({ title: 'ä¿å­˜ä¸­...' });
      
      const res = await api.updateProfile(this.data.profile);
      
      if (res.result?.success) {
        api.showSuccess('ä¿å­˜æˆåŠŸ');
        setTimeout(() => wx.navigateBack(), 1000);
      }
    } catch (error) {
      api.handleError(error, 'ä¿å­˜å¤±è´¥');
    } finally {
      this.setData({ loading: false });
      wx.hideLoading();
    }
  },

  validateInput() {
    const { age, height, weight } = this.data.profile;
    
    if (!calc.validateInput.age(age)) {
      wx.showToast({ title: 'å¹´é¾„åº”åœ¨18-80å²ä¹‹é—´', icon: 'none' });
      return false;
    }
    
    if (!calc.validateInput.height(height)) {
      wx.showToast({ title: 'èº«é«˜åº”åœ¨100-250cmä¹‹é—´', icon: 'none' });
      return false;
    }
    
    if (!calc.validateInput.weight(weight)) {
      wx.showToast({ title: 'ä½“é‡åº”åœ¨30-200kgä¹‹é—´', icon: 'none' });
      return false;
    }
    
    return true;
  }
});
```

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒåŸåˆ™

1. **ç»Ÿä¸€å…¥å£**ï¼šæ‰€æœ‰äº‘å‡½æ•°è°ƒç”¨é€šè¿‡ `cloudApi.js`
2. **ç»Ÿä¸€æ ¼å¼**ï¼šæ‰€æœ‰å“åº”éµå¾ªç»Ÿä¸€æ ¼å¼
3. **ç»Ÿä¸€å¤„ç†**ï¼šä½¿ç”¨ `handleError` å’Œ `showSuccess` å¤„ç†åé¦ˆ
4. **å®‰å…¨ç¬¬ä¸€**ï¼šAPI Key ç»ä¸æš´éœ²åœ¨å‰ç«¯

### æ¨¡å—åˆ†å·¥

| æ¨¡å— | èŒè´£ |
|------|------|
| `cloudApi.js` | äº‘å‡½æ•°è°ƒç”¨æ¥å£ |
| `calculator.js` | å¥åº·è®¡ç®—å’ŒéªŒè¯ |
| `recipeEngine.js` | é£Ÿè°±æ¨èç®—æ³•ï¼ˆæœ¬åœ°ï¼‰ |
| `recipeData.js` | é£Ÿè°±æ•°æ® |

### å¼€å‘æµç¨‹

1. æŸ¥é˜…æœ¬æ–‡æ¡£ï¼Œæ‰¾åˆ°éœ€è¦çš„æ¥å£
2. åœ¨é¡µé¢å¼•å…¥ `cloudApi.js`
3. æŒ‰ç…§ç¤ºä¾‹è°ƒç”¨æ¥å£
4. å¤„ç†å“åº”æ•°æ®
5. æ·»åŠ é”™è¯¯å¤„ç†

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æ›´æ–°æ—¥æœŸ**ï¼š2025-12-09  
**ç»´æŠ¤è€…**ï¼šè½»ç‡ƒå¼€å‘å›¢é˜Ÿ


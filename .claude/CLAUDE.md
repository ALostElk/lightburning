# CLAUDE.md - 轻燃AI运动饮食健康小程序

本文件为 Claude Code 提供项目指导信息。**每次工作前请先阅读本文件**。

---

## 项目概述

**轻燃**是一款AI运动饮食健康微信小程序，通过AI技术整合饮食管理和运动训练，提供一体化的健康管理解决方案。

**技术栈**：微信小程序 + 云函数(Node.js) + 云数据库 + AI API集成（通义千问）

**核心理念**：从"记录工具"升级为"健康顾问"

---

## 系统架构层次

```
┌─────────────────────────────────────────────────────────────────┐
│  展示与激励层（模块八、九）                                        │
│  - 周报/月报可视化 - 智能提醒与推送                                │
├─────────────────────────────────────────────────────────────────┤
│  智能层（模块四、六联动）                                          │
│  - AI运动建议 - AI食谱推荐 - 智能体交互                           │
├─────────────────────────────────────────────────────────────────┤
│  交互层（模块四、五）                                              │
│  - 运动记录入口 - 饮食记录入口 - 食物识别                          │
├─────────────────────────────────────────────────────────────────┤
│  引擎层（模块二、三）                                              │
│  - 每日评价反馈 - 动态计划调整 - 热量差计算                        │
├─────────────────────────────────────────────────────────────────┤
│  数据层（模块一、七）                                              │
│  - 用户档案 - 云数据库存储 - 数据模型管理                          │
└─────────────────────────────────────────────────────────────────┘
```

---

## 项目结构

```
Light Buring 2/
├── miniprogram/                     # 前端小程序 (5-Tab 模式)
│   ├── app.js                       # 全局入口，云初始化
│   ├── app.json                     # 页面路由配置
│   ├── app.wxss                     # 全局样式
│   │
│   ├── components/                  # 可复用UI组件
│   │   ├── ChartCard/               # [模块八] 数据图表
│   │   ├── FoodCard/                # [模块五] 食物卡片
│   │   └── TrainingCard/            # [模块四] 训练卡片
│   │
│   ├── pages/                       # 页面目录
│   │   ├── dashboard/               # [模块二、八、九] "今日"数据看板
│   │   ├── diet/                    # [模块五、六] "饮食"记录管理
│   │   ├── training/                # [模块四] "训练"计划执行
│   │   ├── ai/                      # [模块四、六] "AI助手"
│   │   ├── user/                    # [模块一] "个人中心"
│   │   ├── recipe-recommend/        # [模块六] 食谱推荐页
│   │   ├── recipe-detail/           # [模块六] 食谱详情页
│   │   ├── ai-suggestion/           # [模块六] AI智能推荐页
│   │   └── test-diet/               # 饮食模块测试页面
│   │
│   └── utils/                       # 工具函数
│       ├── api.js                   # 封装 wx.cloud.callFunction
│       ├── constants.js             # 常量定义
│       ├── recipeEngine.js          # [模块六] 推荐引擎算法
│       ├── recipeData.js            # [模块六] 食谱数据
│       └── qwenService.js           # [模块六] 通义千问AI服务
│
├── cloudfunctions/                  # 后端云函数 (4+2 模式)
│   ├── foodRecognitionQwen/         # [模块五] AI视觉识别 ✅
│   ├── userService/                 # [模块一、七] 用户服务
│   ├── dietService/                 # [模块五、七] 饮食服务 ✅
│   ├── trainingService/             # [模块四、七] 训练服务
│   ├── aiAgentService/              # [模块四、六] AI助手服务 ✅ (整合通义千问)
│   └── jobService/                  # [模块二、三、八、九] 定时任务
│
└── .claude/                         # Claude Code 配置
    └── CLAUDE.md                    # 本文件
```

---

## 九大核心模块详解

### 模块一：个人信息数据录入
**页面**：`pages/user/` (个人中心)
**云函数**：`userService`

**功能清单**：
- 基础信息：性别、年龄、身高、体重
- 健康目标：减脂/保持体重，期望周期（如3个月减重5公斤）
- 活动水平：久坐、轻度活动、中度活动、非常活跃（用于计算BMR和TDEE）
- 身体指标（可选）：体脂率、腰围等
- 健康问卷：生活习惯、睡眠质量、压力水平、饮食偏好（素食、不吃辣、过敏源等）

---

### 模块二：饮食运动评价算法
**页面**：`pages/dashboard/` (今日看板)
**云函数**：`jobService`

**核心指标**：
```
每日热量差 = (基础代谢 + 运动消耗) - 饮食摄入
```

**可视化反馈**：
- 红绿灯系统：热量差在目标范围内显示绿色，超出/不足显示黄色/红色
- 进度条：显示"本周累计热量差"
- 营养均衡分：基于蛋白质、碳水、脂肪比例
- 食物多样性分：鼓励关注营养质量

---

### 模块三：动态热量计划与分配系统
**云函数**：`jobService`

**长周期计划**：
1. 根据模块一目标计算总热量缺口（或盈余）
2. 将总目标平均分配到每一周，得出"周目标热量差"

**动态日分配**：
- 允许将某天未完成的热量差分配到未来（或过去）的日子
- 例如：周一聚餐超标300大卡 → 周二周三各增加150大卡热量缺口
- 休息日：可预设某天运动计划为零，饮食目标自动调整为维持体重

**计划弹性度**：
- 严格模式：每日必须完成
- 弹性模式：允许在一周内动态平衡

---

### 模块四：智能体与个性化运动建议
**页面**：`pages/training/`、`pages/ai/`
**云函数**：`trainingService`、`aiAgentService`

**触发条件**：
- 每日推送：根据每天目标热量差和个人信息，智能推送2-3种运动
- 手动添加：用户可灵活添加

**智能建议**：
- 基于数据：连续几天未完成运动计划 → 推荐低强度"补救性"训练
- 基于场景：用户记录"今天很累，肩膀酸" → 推荐10分钟肩颈放松瑜伽

**运动库标签体系**：
- 类型：有氧/无氧/拉伸
- 部位：胸/腿/核心
- 时长：5min/30min
- 器械：需要/无需

---

### 模块五：食物识别与个人食品库 ✅ 已完成
**页面**：`pages/diet/`
**云函数**：`dietService`、`foodRecognitionQwen`
**负责人**：李凯迪

**功能清单**：
| 功能 | 状态 | 说明 |
|------|------|------|
| AI 拍照识别 | ✅ | 通义千问 qwen-vl-plus 视觉模型 |
| 三层搜索架构 | ✅ | 本地DB → AI估算 → Open Food Facts |
| 自动数据积累 | ✅ | 查询结果自动缓存到 FoodDB |
| 个人食品库 | ✅ | 用户自定义菜品 (UserDishes) |
| 我的常用 | ✅ | 基于 DietLog 统计，搜索时自动置顶 |
| 饮食记录 CRUD | ✅ | 完整的增删改查操作 |
| 手动输入流程 | ✅ | quickSearch + searchFood 两层搜索 |

**云函数接口**：
```javascript
wx.cloud.callFunction({
  name: 'dietService',
  data: { action: '操作名', payload: { /* 参数 */ } }
});

// 可用操作
- recognizeAndSearch  // 拍照识别+搜索（一体化）
- quickSearch         // 快速搜索（仅本地，<100ms）
- searchFood          // 完整搜索（三层架构）
- addDietLog          // 添加饮食记录
- getDietLogs         // 获取某日记录
- getDietLogsByRange  // 获取日期范围记录
- updateDietLog       // 更新记录
- deleteDietLog       // 删除记录
- addCustomDish       // 添加自定义菜品
- getUserDishes       // 获取用户菜品
- getFrequentFoods    // 获取常用食物
- calculateCalories   // 计算热量
- initBuiltinFoods    // 初始化内置数据
```

---

### 模块六：推荐食谱与智能体联动 ✅ 已完成
**页面**：`pages/recipe-recommend/`、`pages/recipe-detail/`、`pages/ai-suggestion/`
**云函数**：`aiAgentService`

**推荐逻辑**：
- 基于目标：推荐符合每日热量和营养目标（高蛋白、低卡等）的食谱
- 基于偏好：结合模块一的饮食偏好和模块五的常吃食物
- AI智能推荐：分析近7天饮食数据，检测营养缺口

**与智能体联动**：
- 智能体不仅推荐运动，还在饮食记录不佳时主动推荐健康食谱
- 例如："检测到您近期蛋白质摄入较低，试试这道高蛋白的虾仁蒸蛋吧！"

**云函数接口**：
```javascript
wx.cloud.callFunction({
  name: 'aiAgentService',
  data: {
    action: 'analyzeAndRecommend',  // 分析并推荐
    userData: { /* 用户信息 */ },
    dietRecords: [ /* 饮食记录 */ ],
    nutritionGap: { /* 营养缺口 */ }
  }
});

// 可用操作（aiAgentService 统一入口）
- chat                  // AI对话（模块四）
- analyzeAndRecommend   // 分析用户饮食并生成推荐（模块六）
- generateRecipeReason  // 为食谱生成AI推荐理由（模块六）
- recommendExercise     // 智能运动推荐（模块四，预留）
- customPrompt          // 自定义提示词
```

---

### 模块七：后端数据模型
**云函数**：所有云函数共用

**数据库集合**：
| 集合名 | 权限 | 说明 |
|--------|------|------|
| `Users` | 仅创建者可读写 | 用户档案（模块一信息） |
| `FoodDB` | 所有用户可读，仅管理员可写 | 公共食物数据库（含40+内置食物） |
| `UserDishes` | 仅创建者可读写 | 用户自定义菜品 |
| `DietLog` | 仅创建者可读写 | 饮食流水记录 |
| `TrainingPlan` | 仅创建者可读写 | 运动计划表 |
| `TrainingLog` | 仅创建者可读写 | 运动记录表 |
| `Recipes` | 所有用户可读 | 推荐食谱库 |
| `UnitMap` | 所有用户可读 | 单位映射表 |

---

### 模块八：数据可视化与报告
**页面**：`pages/dashboard/`
**云函数**：`jobService`

**功能**：
- 周报/月报：图表展示热量差趋势、体重变化、运动习惯、营养摄入比例
- 文字总结："本周你平均每天产生了200大卡的热量缺口，照此趋势，预计X周后达到目标！"

---

### 模块九：消息推送与提醒
**云函数**：`jobService`

**智能提醒**：
- 不是简单的"该运动了"，而是基于数据的提醒
- 例如："今天您还剩余300大卡的热量预算，可以享受一份水果酸奶哦！"

---

## 模块开发进度

| 模块 | 名称 | 负责人 | 状态 |
|------|------|--------|------|
| 模块一 | 个人信息数据录入 | - | 待开发 |
| 模块二 | 饮食运动评价算法 | - | 待开发 |
| 模块三 | 动态热量计划与分配 | - | 待开发 |
| 模块四 | 智能体与个性化运动建议 | - | 待开发 |
| 模块五 | 食物识别与个人食品库 | 李凯迪 | ✅ 已完成 |
| 模块六 | 推荐食谱与智能体联动 | - | ✅ 已完成 |
| 模块七 | 后端数据模型 | - | 部分完成 |
| 模块八 | 数据可视化与报告 | - | 待开发 |
| 模块九 | 消息推送与提醒 | - | 待开发 |

---

## 环境变量配置

在云函数配置中添加：

| 云函数 | 变量名 | 值 |
|--------|--------|-----|
| `dietService` | `DASHSCOPE_API_KEY` | `sk-xxxxx` |
| `foodRecognitionQwen` | `DASHSCOPE_API_KEY` | `sk-xxxxx` |
| `aiAgentService` | `DASHSCOPE_API_KEY` | `sk-xxxxx` |

**API Key 获取**：https://dashscope.console.aliyun.com/

---

## 全局数据配置

在 `app.js` 的 `globalData` 中：

```javascript
globalData: {
  env: "cloud1-2go01dute64ce171",  // 云环境ID
  userInfo: null,
  userProfile: null,
  todayDataCache: null,
  // 每日营养目标（模块六使用）
  dailyCalorieGoal: 1800,   // 每日热量目标（千卡）
  dailyProteinGoal: 120,    // 每日蛋白质目标（克）
  dailyCarbGoal: 180,       // 每日碳水目标（克）
  dailyFatGoal: 50,         // 每日脂肪目标（克）
}
```

---

## 开发规范

### 云函数开发
- 使用 `wx-server-sdk` 初始化
- 统一返回格式：`{ success: true/false, data/error }`
- 超时配置在 `config.json` 中设置
- 大图片通过云存储传递 fileID，不直接传 Base64

### 搜索策略
```
用户输入
    │
    ├─ 实时输入 → quickSearch（仅本地，<100ms）
    │
    └─ 点击搜索 → searchFood（三层架构）
                    │
                    ├─ 第一层：本地 FoodDB（极速）
                    ├─ 第二层：AI 估算（智能）
                    └─ 第三层：Open Food Facts（兜底）
```

### 部署命令
```bash
# 方法一：使用部署脚本
./uploadCloudFunction.sh

# 方法二：微信开发者工具
# 右键点击云函数目录 → 上传并部署（云端安装依赖）
```

---

## 注意事项

1. **图片上传**：必须先上传到云存储，再传 fileID（避免请求大小限制）
2. **超时配置**：dietService 120s，foodRecognitionQwen 60s，aiAgentService 60s
3. **费用估算**：通义千问约 0.008 元/次识别，日均100次约 0.8 元/天
4. **数据自动积累**：搜索结果自动写入 FoodDB，越用越快
5. **AI降级策略**：AI调用失败时自动切换到规则推荐，保证功能可用

---

## 联系方式

- 模块五开发者：李凯迪
- 项目仓库：Light Buring 2

---

**最后更新**：2024年12月

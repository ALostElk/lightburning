# QwenAI 云函数

## 功能说明

通义千问AI分析云函数，用于代理小程序调用通义千问API，避免暴露API Key。

## 主要功能

1. **分析并推荐** (`analyzeAndRecommend`)
   - 分析用户饮食习惯
   - 生成营养建议
   - 推荐食物类型和烹饪方式

2. **生成食谱推荐理由** (`generateRecipeReason`)
   - 为特定食谱生成推荐理由
   - 结合用户目标和营养缺口

3. **自定义提示词** (`customPrompt`)
   - 自定义AI对话

## 配置说明

### 超时设置

云函数已配置20秒超时时间（`config.json`），适应AI响应时间。

### 环境变量

需要配置以下环境变量：
- `DASHSCOPE_API_KEY` 或 `QWEN_API_KEY`: 通义千问API密钥

## 部署步骤

### 1. 在微信开发者工具中部署

1. 打开微信开发者工具
2. 右键点击 `cloudfunctions/qwenAI` 文件夹
3. 选择"上传并部署：云端安装依赖"
4. 等待部署完成

### 2. 配置环境变量（如果使用）

1. 登录[微信云开发控制台](https://console.cloud.tencent.com/tcb)
2. 选择你的环境
3. 进入"云函数" -> 找到 `qwenAI`
4. 点击"函数配置"
5. 添加环境变量：
   - 键：`DASHSCOPE_API_KEY`
   - 值：你的通义千问API密钥

### 3. 验证部署

在小程序中测试AI功能，查看是否正常工作。

## 性能优化

### 已实施的优化

1. **超时控制**
   - 云函数配置：20秒
   - HTTP请求超时：12-15秒
   - 小程序调用超时：20秒

2. **提示词优化**
   - 简化提示词，减少token消耗
   - 限制建议数量（最多3条）
   - 要求简洁输出

3. **错误处理**
   - 超时自动降级到默认规则
   - 详细的日志记录
   - 友好的错误提示

### 故障排查

#### 问题：云函数超时

**可能原因：**
1. 网络延迟
2. AI API响应慢
3. 超时设置过短

**解决方案：**
1. 检查 `config.json` 中的 `timeout` 配置（当前为20秒）
2. 检查小程序端调用的 `timeout` 配置（当前为20000ms）
3. 查看云函数日志，确认实际耗时

#### 问题：AI返回格式错误

**可能原因：**
1. AI返回了非JSON格式
2. 提示词不够清晰

**解决方案：**
1. 已添加自动降级逻辑
2. 会使用默认规则生成建议

## 开发建议

1. **本地测试**
   - 可以在云函数日志中查看详细的请求和响应
   - 建议先在开发环境测试

2. **监控**
   - 定期查看云函数调用次数和失败率
   - 关注超时情况

3. **优化方向**
   - 考虑缓存AI响应结果
   - 可以实现批量请求优化
   - 考虑使用更快的AI模型

## 更新日志

### 2024-12-13
- 增加超时配置（20秒）
- 优化提示词，减少响应时间
- 添加详细的错误处理和日志
- 改进JSON解析逻辑
- 添加自动降级机制

# 数据库初始化指南

## 📌 必须创建的数据库集合

在微信开发者工具中创建以下数据库集合（表）：

### 1. 在微信开发者工具中操作

1. 点击顶部菜单栏的 **"云开发"** 按钮
2. 进入云开发控制台
3. 点击左侧 **"数据库"** 标签
4. 点击 **"+"** 按钮，创建以下集合

---

## 🗄️ 需要创建的集合列表

### 核心集合（必须创建）

#### 1. UserProfiles
**说明**：用户个人信息
```json
权限设置：仅创建者可读写
```

#### 2. Plans
**说明**：减重计划
```json
权限设置：仅创建者可读写
```

#### 3. DailyEvaluations
**说明**：每日评价记录
```json
权限设置：仅创建者可读写
```

#### 4. DietLog
**说明**：饮食记录
```json
权限设置：仅创建者可读写
```

#### 5. ExerciseLog
**说明**：运动记录
```json
权限设置：仅创建者可读写
```

#### 6. exercise_records
**说明**：运动记录（备用集合）
```json
权限设置：仅创建者可读写
```

#### 7. FoodDB
**说明**：食物数据库（公共）
```json
权限设置：所有用户可读，仅创建者可写
```

#### 8. UserDishes
**说明**：用户自定义菜品
```json
权限设置：仅创建者可读写
```

---

## 📝 详细创建步骤

### 步骤1：打开云开发控制台
在微信开发者工具中：
1. 点击顶部的 **"云开发"** 按钮
2. 等待控制台加载完成

### 步骤2：创建集合
1. 点击左侧 **"数据库"**
2. 点击 **"+"** 或 **"添加集合"**
3. 输入集合名称（完全按照上面的名称输入）
4. 点击 **"确定"**

### 步骤3：设置权限
对于每个集合，点击集合名称进入详情页，然后：
1. 点击 **"权限设置"** 标签
2. 选择对应的权限模式：
   - **UserProfiles, Plans, DailyEvaluations, DietLog, ExerciseLog, exercise_records, UserDishes**：
     选择 **"仅创建者可读写"**
   - **FoodDB**：
     选择 **"所有用户可读，仅创建者可写"**

---

## 🚀 初始化食物数据

创建完集合后，需要初始化 FoodDB 的基础数据：

### 方法1：在微信开发者工具控制台执行

在微信开发者工具的控制台（Console）中执行：

```javascript
wx.cloud.callFunction({
  name: 'dietService',
  data: {
    action: 'initBuiltinFoods'
  }
}).then(res => {
  console.log('食物数据初始化成功:', res);
}).catch(err => {
  console.error('初始化失败:', err);
});
```

### 方法2：在小程序中添加临时按钮

在 `pages/home/index.wxml` 中临时添加（测试完成后删除）：

```xml
<button bindtap="initFoodDB">初始化食物数据库</button>
```

在 `pages/home/index.js` 中添加：

```javascript
initFoodDB() {
  wx.showLoading({ title: '初始化中...' });
  
  wx.cloud.callFunction({
    name: 'dietService',
    data: {
      action: 'initBuiltinFoods'
    }
  }).then(res => {
    wx.hideLoading();
    if (res.result.success) {
      wx.showToast({
        title: `成功添加 ${res.result.data.added} 条数据`,
        icon: 'success'
      });
    }
  }).catch(err => {
    wx.hideLoading();
    wx.showModal({
      title: '初始化失败',
      content: err.errMsg || '未知错误'
    });
  });
}
```

---

## ✅ 验证数据库是否创建成功

### 检查集合列表
在云开发控制台的数据库页面，应该看到 8 个集合：
- ✓ UserProfiles
- ✓ Plans
- ✓ DailyEvaluations
- ✓ DietLog
- ✓ ExerciseLog
- ✓ exercise_records
- ✓ FoodDB
- ✓ UserDishes

### 检查 FoodDB 数据
1. 点击 **FoodDB** 集合
2. 应该能看到约 40+ 条食物记录
3. 包括：燕麦、鸡胸肉、鸡蛋、牛奶等常见食物

---

## 🔧 常见问题

### Q1: 创建集合时提示"集合名称已存在"
**A**: 说明该集合已经存在，跳过即可。

### Q2: 初始化食物数据时提示"已存在"
**A**: 正常，`initBuiltinFoods` 会自动跳过已有数据，不会重复添加。

### Q3: 权限设置找不到"仅创建者可读写"选项
**A**: 
- 如果是个人小程序，直接选择"仅创建者可读写"
- 如果是企业小程序，可能需要使用自定义安全规则

### Q4: FoodDB 初始化后数据为空
**A**: 检查云函数 `dietService` 是否部署成功，查看控制台是否有错误日志。

---

## 📊 可选：手动添加测试数据

如果需要测试，可以在数据库中手动添加一条用户信息：

**UserProfiles 集合添加测试数据：**

```json
{
  "gender": "male",
  "age": 25,
  "height": 175,
  "weight": 70,
  "goal": "减脂",
  "targetWeight": 65,
  "activityLevel": 1.375,
  "bmr": 1680,
  "tdee": 2310,
  "bmi": 22.9,
  "updatedAt": 1733734800000,
  "createdAt": 1733734800000
}
```

注意：添加数据时，微信云开发会自动添加 `_openid` 和 `_id` 字段。

---

## 🎉 完成！

创建完这 8 个集合并初始化 FoodDB 后，您的小程序就可以正常运行了！

重新打开小程序首页，应该不会再出现 "collection not exists" 错误。


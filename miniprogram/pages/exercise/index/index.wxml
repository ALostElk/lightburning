<!--
  è¿åŠ¨è®°å½•ä¸»é¡µ - exercise/index
  è®¾è®¡è¯­è¨€: Daylight Futurism (æ—¥å…‰æœªæ¥ä¸»ä¹‰)
  åŠŸèƒ½: æŠ˜å è¿åŠ¨ç±»å‹ + æ—¥å†é€‰æ‹©
-->
<view class="page-container">
  <!-- ============ ç²˜æ€§å¤´éƒ¨ ============ -->
  <view class="sticky-header" style="padding-top: {{statusBarHeight}}px;">
    <view class="header-content">
      <!-- å·¦ä¾§ï¼šç”¨æˆ·ä¿¡æ¯ -->
      <view class="user-info">
        <view class="avatar-wrapper">
          <image
            class="user-avatar"
            src="{{userInfo.avatarUrl || '/images/default-avatar.png'}}"
            mode="aspectFill"
          />
          <view class="status-dot"></view>
        </view>
        <view class="user-text">
          <text class="greeting">{{greeting}}</text>
          <text class="user-name">{{userInfo.nickName || 'è¿åŠ¨è¾¾äºº'}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ============ ä¸»å†…å®¹åŒº ============ -->
  <view class="main-content">
    <!-- ============ æ—¥æœŸåˆ‡æ¢å¯¼èˆªæ  ============ -->
    <view class="date-nav-bar">
      <view class="date-nav-arrow" bindtap="goToPrevDay">
        <text class="arrow-icon">â€¹</text>
      </view>
      <view class="date-nav-center" bindtap="showCalendar">
        <text class="date-nav-text">{{dateDisplay}}</text>
      </view>
      <view class="date-nav-arrow" bindtap="goToNextDay">
        <text class="arrow-icon">â€º</text>
      </view>
    </view>

    <!-- AI åˆ†ææ¨ªå¹…ï¼ˆæ¡ä»¶æ¸²æŸ“ï¼‰ -->
    <view class="ai-banner animate-fade-in-up" wx:if="{{aiInsight}}">
      <view class="ai-banner-content">
        <view class="ai-icon-wrapper">
          <text class="ai-icon">ğŸ§ </text>
        </view>
        <view class="ai-text">
          <text class="ai-title">AI æ™ºèƒ½åˆ†æ</text>
          <text class="ai-message">{{aiInsight}}</text>
        </view>
      </view>
      <view class="ai-close" bindtap="closeAIBanner">
        <text>Ã—</text>
      </view>
    </view>

    <!-- ============ ä»ªè¡¨ç›˜å¡ç‰‡ ============ -->
    <spotlight-card customClass="dashboard-card" holo="{{true}}" customStyle="background: linear-gradient(135deg, #FFF7ED 0%, #FFEDD5 100%)">
      <view class="dashboard-content">
        <!-- çƒ­é‡ç¯å½¢å›¾ + æ ¸å¿ƒæ•°æ® -->
        <view class="calories-dashboard">
            <!-- Liquid Sphere Dashboard -->
            <view class="liquid-sphere">
              <!-- ç»ç’ƒçƒå†…éƒ¨å…‰æ™• -->
              <view class="sphere-inner-glow"></view>

              <!-- æ¶²ä½“å®¹å™¨ - åªæœ‰è¿›åº¦å¤§äº0æ—¶æ‰æ˜¾ç¤ºæ¶²ä½“ -->
              <view class="liquid-container">
                <view
                  wx:if="{{liquidProgress > 0}}"
                  class="liquid-fluid"
                  style="height: {{liquidProgress}}%"
                >
                  <!-- é¢å¤–æ³¢æµªå±‚ - ç”¨äºæ›´ä¸°å¯Œçš„æ³¢æµªæ•ˆæœ -->
                  <view class="wave-layer wave-1"></view>
                  <view class="wave-layer wave-2"></view>
                  <view class="wave-layer wave-3"></view>

                  <!-- æ¶²ä½“å†…éƒ¨é«˜å…‰ -->
                  <view class="liquid-highlight"></view>
                </view>
              </view>

              <!-- ç»ç’ƒçƒè¾¹ç¼˜å…‰æ³½ -->
              <view class="sphere-rim-light"></view>

              <!-- ä¸­å¿ƒæ•°æ® -->
              <view class="donut-center">
                <view class="donut-value-wrapper">
                  <text class="donut-value">{{stats.totalCalories}}</text>
                  <text class="donut-unit">kcal</text>
                </view>
                <text class="donut-label">å·²æ¶ˆè€—</text>
              </view>
            </view>

          <!-- å³ä¾§ï¼šè¯¦ç»†æ•°æ® -->
          <view class="calories-details">
            <view class="calorie-row">
              <view class="calorie-indicator consumed"></view>
              <text class="calorie-label">å·²æ¶ˆè€—</text>
              <view class="calorie-value-wrapper">
                <text class="calorie-value">{{stats.totalCalories}}</text>
                <text class="calorie-unit">kcal</text>
              </view>
            </view>
            <view class="calorie-row">
              <view class="calorie-indicator duration"></view>
              <text class="calorie-label">æ€»æ—¶é•¿</text>
              <view class="calorie-value-wrapper">
                <text class="calorie-value">{{stats.totalDuration}}</text>
                <text class="calorie-unit">åˆ†é’Ÿ</text>
              </view>
            </view>
            <view class="calorie-row goal">
              <view class="calorie-indicator goal-ind"></view>
              <text class="calorie-label">ç›®æ ‡</text>
              <view class="calorie-value-wrapper">
                <text class="calorie-value">{{stats.targetCalories}}</text>
                <text class="calorie-unit">kcal</text>
              </view>
            </view>
          </view>
        </view>

        <!-- è¿åŠ¨æ—¶é•¿è¿›åº¦æ¡ -->
        <view class="macros-section">
          <view class="macro-bar">
            <view class="macro-info">
              <text class="macro-name">è¿åŠ¨æ—¶é•¿</text>
              <text class="macro-values">{{stats.totalDuration}}åˆ†é’Ÿ / {{stats.targetDuration}}åˆ†é’Ÿ</text>
            </view>
            <view class="macro-progress-bg">
              <view
                class="macro-progress-fill duration-fill"
                style="width: {{stats.durationPercentage > 100 ? 100 : stats.durationPercentage}}%"
              ></view>
            </view>
          </view>
        </view>
      </view>
    </spotlight-card>

    <!-- ============ è¿åŠ¨æ—¶é—´çº¿ ============ -->
    <view class="timeline-section">
      <view class="section-header">
        <text class="section-title">è¿åŠ¨è®°å½•</text>
        <view class="header-right">
          <!-- ç¼–è¾‘æ¨¡å¼æŒ‰é’® -->
          <view class="edit-btn {{isEditMode ? 'active' : ''}}" catchtap="toggleEditMode">
            <text>{{isEditMode ? 'å®Œæˆ' : 'ç¼–è¾‘'}}</text>
          </view>
        </view>
      </view>

      <!-- æ—¶é—´çº¿å®¹å™¨ -->
      <view class="timeline-container">
        <block wx:for="{{exerciseTypes}}" wx:key="id">
          <!-- æ—¶é—´çº¿èŠ‚ç‚¹ -->
          <view class="timeline-item">
            <!-- æ—¶é—´çº¿ -->
            <view class="timeline-track">
              <view class="timeline-dot {{item.totalCalories > 0 ? 'active' : ''}}">
                <text class="dot-icon">{{item.emojiIcon}}</text>
              </view>
              <view class="timeline-line" wx:if="{{index < exerciseTypes.length - 1}}"></view>
            </view>

            <!-- è¿åŠ¨ç±»å‹å¡ç‰‡ -->
            <view class="type-card-wrapper">
              <spotlight-card
                customClass="type-card {{item.type}} {{item.totalCalories > 0 ? 'has-data' : ''}}"
                customStyle="{{item.bgStyle}}"
              >
                <!-- ç‚¹å‡»å¡ç‰‡ç©ºç™½åŒºåŸŸåˆ‡æ¢æŠ˜å çŠ¶æ€ -->
                <view class="type-card-content" bindtap="onTypeCardTap" data-type="{{item.type}}">
                  <!-- å¡ç‰‡å¤´éƒ¨ -->
                  <view class="type-header">
                    <view class="type-title-group">
                      <text class="type-title">{{item.title}}</text>
                      <text class="type-time">{{item.suggestMin}}-{{item.suggestMax}} åˆ†é’Ÿ</text>
                    </view>
                    <view class="type-right-section">
                      <!-- å•ç±»å‹ç¼–è¾‘æŒ‰é’® -->
                      <view
                        class="type-edit-btn {{item.isEditing ? 'active' : ''}}"
                        catchtap="toggleTypeEdit"
                        data-type="{{item.type}}"
                        wx:if="{{item.items.length > 0}}"
                      >
                        <text>{{item.isEditing ? 'å®Œæˆ' : 'ç¼–è¾‘'}}</text>
                      </view>
                      <view class="type-calories" wx:if="{{item.totalCalories > 0}}">
                        <text class="cal-number">{{item.totalCalories}}</text>
                        <text class="cal-unit">kcal</text>
                      </view>
                      <!-- æŠ˜å /å±•å¼€å›¾æ ‡ -->
                      <view class="collapse-icon {{item.collapsed ? 'collapsed' : ''}}" catchtap="toggleTypeCollapse" data-type="{{item.type}}">
                        <text>â–¼</text>
                      </view>
                    </view>
                  </view>

                  <!-- è¿›åº¦æ¡ -->
                  <view class="type-progress-wrapper">
                    <view class="type-progress-bar">
                      <view
                        class="type-progress-fill {{item.percentage > 100 ? 'over' : ''}}"
                        style="width: {{item.percentage > 100 ? 100 : item.percentage}}%"
                      ></view>
                    </view>
                    <text class="type-progress-text">{{item.percentage}}%</text>
                  </view>

                  <!-- å¯æŠ˜å çš„è¿åŠ¨åˆ—è¡¨ -->
                  <view class="collapsible-content {{item.collapsed ? 'collapsed' : ''}}">
                    <!-- è¿åŠ¨åˆ—è¡¨ -->
                    <view class="exercise-items" wx:if="{{item.items.length > 0}}">
                      <block wx:for="{{item.items}}" wx:for-item="exercise" wx:key="uniqueId">
                        <!-- å·¦æ»‘åˆ é™¤å®¹å™¨ -->
                        <view class="exercise-item-wrapper">
                          <view
                            class="exercise-item {{exercise.swiped ? 'swiped' : ''}}"
                            bindtouchstart="onExerciseTouchStart"
                            bindtouchmove="onExerciseTouchMove"
                            bindtouchend="onExerciseTouchEnd"
                            data-id="{{exercise.id}}"
                            data-type="{{item.type}}"
                          >
                            <!-- ç¼–è¾‘æ¨¡å¼é€‰æ‹©æ¡†ï¼ˆå…¨å±€æˆ–å•ç±»å‹ï¼‰ -->
                            <view class="exercise-checkbox {{isEditMode || item.isEditing ? 'show' : ''}}" catchtap="toggleExerciseSelect" data-id="{{exercise.id}}" data-type="{{item.type}}">
                              <view class="checkbox-inner {{exercise.selected ? 'checked' : ''}}">
                                <text wx:if="{{exercise.selected}}">âœ“</text>
                              </view>
                            </view>
                            <view class="exercise-left" catchtap="{{isEditMode || item.isEditing ? 'stopPropagation' : 'openExerciseEdit'}}" data-exercise="{{exercise}}" data-type="{{item.type}}">
                              <text class="exercise-emoji">{{exercise.emoji}}</text>
                              <view class="exercise-info">
                                <text class="exercise-name">{{exercise.name}}</text>
                                <text class="exercise-duration">{{exercise.duration}}åˆ†é’Ÿ</text>
                              </view>
                            </view>
                            <view class="exercise-right" catchtap="{{isEditMode || item.isEditing ? 'stopPropagation' : 'openExerciseEdit'}}" data-exercise="{{exercise}}" data-type="{{item.type}}">
                              <text class="exercise-cal">{{exercise.calories}}</text>
                              <text class="exercise-cal-unit">kcal</text>
                            </view>
                          </view>
                          <!-- å·¦æ»‘åˆ é™¤æŒ‰é’® -->
                          <view class="swipe-delete-btn" catchtap="deleteSingleExercise" data-id="{{exercise.id}}">
                            <text>åˆ é™¤</text>
                          </view>
                        </view>
                      </block>

                      <!-- æ·»åŠ æ›´å¤š -->
                      <view
                        class="add-type-btn-large"
                        catchtap="addExercise"
                        data-type="{{item.type}}"
                        wx:if="{{!isEditMode && !item.isEditing}}"
                      >
                        <text class="add-icon">+</text>
                        <text class="add-text">æ·»åŠ {{item.title}}</text>
                      </view>
                    </view>

                    <!-- ç©ºçŠ¶æ€ -->
                    <view class="empty-state" wx:if="{{item.items.length === 0}}">
                      <text class="empty-hint">{{item.emptyText}}</text>
                      <view
                        class="add-type-btn-large"
                        catchtap="addExercise"
                        data-type="{{item.type}}"
                      >
                        <text class="add-icon">+</text>
                        <text class="add-text">æ·»åŠ {{item.title}}</text>
                      </view>
                    </view>
                  </view>
                </view>
              </spotlight-card>
            </view>
          </view>
        </block>
      </view>
    </view>

    <!-- åº•éƒ¨å®‰å…¨åŒºåŸŸ -->
    <view class="bottom-spacer"></view>
  </view>

  <!-- ============ æ‰¹é‡æ“ä½œæ  ============ -->
  <view class="batch-action-bar {{(isEditMode || hasAnyTypeEditing) && selectedCount > 0 ? 'show' : ''}}">
    <view class="batch-info">
      <text class="selected-count">å·²é€‰æ‹© {{selectedCount}} é¡¹</text>
      <text class="selected-calories">å…± {{selectedCalories}} kcal</text>
    </view>
    <view class="batch-actions">
      <view class="batch-btn select-all" catchtap="toggleSelectAll">
        <text>{{isAllSelected ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰'}}</text>
      </view>
      <view class="batch-btn delete" catchtap="deleteSelectedExercises">
        <text>ğŸ—‘ï¸ åˆ é™¤</text>
      </view>
    </view>
  </view>

  <!-- ============ æµ®åŠ¨æœç´¢æŒ‰é’® ============ -->
  <floating-fab
    icon="ğŸ”"
    position="bottom-center"
    theme="glass"
    safeArea="{{true}}"
    bindtap="goToSearch"
  />

  <!-- ============ æ—¥å†é€‰æ‹©å™¨å¼¹çª— ============ -->
  <view class="calendar-modal {{showCalendarModal ? 'show' : ''}}" catchtap="hideCalendar">
    <view class="calendar-content" catchtap="stopPropagation">
      <view class="calendar-header">
        <view class="calendar-nav" bindtap="prevMonth">
          <text>â€¹</text>
        </view>
        <text class="calendar-title">{{calendarYear}}å¹´{{calendarMonth}}æœˆ</text>
        <view class="calendar-nav" bindtap="nextMonth">
          <text>â€º</text>
        </view>
      </view>

      <!-- æ˜ŸæœŸå¤´ -->
      <view class="calendar-weekdays">
        <text class="weekday">æ—¥</text>
        <text class="weekday">ä¸€</text>
        <text class="weekday">äºŒ</text>
        <text class="weekday">ä¸‰</text>
        <text class="weekday">å››</text>
        <text class="weekday">äº”</text>
        <text class="weekday">å…­</text>
      </view>

      <!-- æ—¥æœŸç½‘æ ¼ -->
      <view class="calendar-days">
        <block wx:for="{{calendarDays}}" wx:key="date">
          <view
            class="calendar-day {{item.isCurrentMonth ? '' : 'other-month'}} {{item.isToday ? 'today' : ''}} {{item.isSelected ? 'selected' : ''}} {{item.hasRecord ? 'has-record' : ''}} {{item.isFuture ? 'future' : ''}}"
            bindtap="{{item.isFuture ? '' : 'selectCalendarDay'}}"
            data-date="{{item.date}}"
          >
            <text class="day-number">{{item.day}}</text>
            <view class="record-dot" wx:if="{{item.hasRecord}}"></view>
          </view>
        </block>
      </view>

      <!-- å¿«æ·é€‰é¡¹ -->
      <view class="calendar-shortcuts">
        <view class="shortcut-btn" bindtap="selectToday">ä»Šå¤©</view>
        <view class="shortcut-btn" bindtap="selectYesterday">æ˜¨å¤©</view>
        <view class="shortcut-btn" bindtap="selectThisWeek">æœ¬å‘¨</view>
      </view>
    </view>
  </view>

  <!-- ============ åŠ è½½é®ç½© ============ -->
  <view class="loading-overlay" wx:if="{{isLoading}}">
    <view class="loading-content">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
  </view>

  <!-- ============ è¿åŠ¨ç¼–è¾‘å¼¹çª— ============ -->
  <view class="exercise-edit-modal {{showExerciseEditModal ? 'show' : ''}}" catchtap="closeExerciseEdit">
    <view class="exercise-edit-content" catchtap="stopPropagation">
      <!-- å¼¹çª—å¤´éƒ¨ -->
      <view class="exercise-edit-header">
        <text class="exercise-edit-title">ç¼–è¾‘è¿åŠ¨</text>
        <view class="exercise-edit-close" bindtap="closeExerciseEdit">
          <text>Ã—</text>
        </view>
      </view>

      <!-- è¿åŠ¨ä¿¡æ¯ -->
      <view class="exercise-edit-info">
        <view class="exercise-edit-avatar">
          <text class="exercise-edit-emoji">{{editingExercise.emoji || 'ğŸƒ'}}</text>
        </view>
        <view class="exercise-edit-name">{{editingExercise.name}}</view>
      </view>

      <!-- æ—¶é•¿è¾“å…¥ -->
      <view class="exercise-edit-form">
        <!-- æ—¶é•¿æ˜¾ç¤º -->
        <view class="amount-header">
          <text class="form-label">è¿åŠ¨æ—¶é•¿</text>
          <view class="amount-display">
            <text class="amount-value">{{editingExercise.duration}}</text>
            <text class="amount-unit-text">åˆ†é’Ÿ</text>
          </view>
        </view>

        <!-- æ»‘åŠ¨æ¡åŒºåŸŸ -->
        <view class="slider-container">
          <view class="slider-track">
            <view class="slider-fill" style="width: {{(editingExercise.duration / 120) * 100}}%"></view>
          </view>
          <slider class="amount-slider"
                  min="5"
                  max="120"
                  step="5"
                  value="{{editingExercise.duration}}"
                  activeColor="transparent"
                  backgroundColor="transparent"
                  block-size="0"
                  bindchange="onSliderChange"
                  bindchanging="onSliderChanging" />
          <!-- æ»‘å—å›¾æ ‡ -->
          <view class="slider-thumb" style="left: {{(editingExercise.duration / 120) * 100}}%">
            <view class="thumb-icon">
              <text>{{editingExercise.emoji || 'ğŸƒ'}}</text>
            </view>
          </view>
          <!-- åˆ»åº¦æ ‡è®° -->
          <view class="slider-marks">
            <text class="mark">5åˆ†</text>
            <text class="mark">60åˆ†</text>
            <text class="mark">120åˆ†</text>
          </view>
        </view>

        <!-- å¿«æ·æ—¶é•¿é€‰æ‹© -->
        <view class="quick-durations">
          <view class="quick-durations-label">å¿«æ·é€‰æ‹©</view>
          <view class="quick-durations-btns">
            <view class="quick-duration-btn" bindtap="setQuickDuration" data-duration="15">15åˆ†</view>
            <view class="quick-duration-btn" bindtap="setQuickDuration" data-duration="30">30åˆ†</view>
            <view class="quick-duration-btn" bindtap="setQuickDuration" data-duration="45">45åˆ†</view>
            <view class="quick-duration-btn" bindtap="setQuickDuration" data-duration="60">60åˆ†</view>
            <view class="quick-duration-btn" bindtap="setQuickDuration" data-duration="90">90åˆ†</view>
            <view class="quick-duration-btn" bindtap="setQuickDuration" data-duration="120">120åˆ†</view>
          </view>
        </view>

        <!-- çƒ­é‡é¢„è§ˆ -->
        <view class="calories-preview">
          <view class="preview-row">
            <text class="preview-label">æ¶ˆè€—çƒ­é‡</text>
            <text class="preview-value">{{editingExercise.calculatedCalories || 0}} kcal</text>
          </view>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="exercise-edit-actions">
        <view class="edit-btn-cancel" bindtap="closeExerciseEdit">å–æ¶ˆ</view>
        <view class="edit-btn-save" bindtap="saveExerciseEdit">ä¿å­˜ä¿®æ”¹</view>
      </view>
    </view>
  </view>
</view>

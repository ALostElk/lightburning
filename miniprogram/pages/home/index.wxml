<!-- pages/home/index.wxml -->
<view class="page">

    <!-- ============ ç²˜æ€§å¤´éƒ¨ ============ -->
  <view class="sticky-header" style="padding-top: {{statusBarHeight}}px;">
    <view class="header-content">
      <!-- å·¦ä¾§ï¼šç”¨æˆ·ä¿¡æ¯ -->
      <view class="user-info">
        <view class="avatar-wrapper">
          <image
            class="user-avatar"
            src="{{profile && profile.avatar ? profile.avatar : '/images/default-avatar.png'}}"
            mode="aspectFill"
          />
          <view class="status-dot"></view>
        </view>
        <view class="user-text">
          <text class="greeting">{{formattedDate}}</text>
          <text class="user-name">{{profile && profile.name ? profile.name : 'å¥åº·è¾¾äºº'}}</text>
        </view>
      </view>

      <!-- å³ä¾§ï¼šç›®æ ‡çŠ¶æ€ -->
      <view class="goal-status" wx:if="{{profile && profile.goal}}">
        <view class="status-badge" wx:if="{{calorieProgress >= 80}}">
          <text class="status-icon">ğŸ¯</text>
          <text class="status-text">ç›®æ ‡è¾¾æˆ</text>
        </view>
        <view class="status-badge progress" wx:elif="{{calorieProgress >= 50}}">
          <text class="status-icon">ğŸ“ˆ</text>
          <text class="status-text">è¿›åº¦è‰¯å¥½</text>
        </view>
        <view class="status-badge" wx:else>
          <text class="status-icon">ğŸ’ª</text>
          <text class="status-text">ç»§ç»­åŠªåŠ›</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ============ ä¸»å†…å®¹åŒº ============ -->
  <view class="main-content">
    <!-- ============ æ—¥æœŸåˆ‡æ¢å¯¼èˆªæ  ============ -->
    <view class="date-nav-bar">
      <view class="date-nav-arrow" bindtap="goToPrevDay">
        <text class="arrow-icon">â€¹</text>
      </view>
      <view class="date-nav-center" bindtap="showCalendar">
        <text class="date-nav-text">{{formattedDate}}</text>
      </view>
      <view class="date-nav-arrow" bindtap="goToNextDay">
        <text class="arrow-icon">â€º</text>
      </view>
    </view>

    <!-- AI åˆ†ææ¨ªå¹…ï¼ˆæ¡ä»¶æ¸²æŸ“ï¼‰ -->
    <view class="ai-banner animate-fade-in-up" wx:if="{{aiInsight.message}}" data-priority="{{aiInsight.priority}}">
      <view class="ai-banner-content">
        <view class="ai-icon-wrapper">
          <text class="ai-icon">{{aiInsight.type === 'diet' ? 'ğŸ½ï¸' : aiInsight.type === 'exercise' ? 'ğŸ’ª' : aiInsight.type === 'balance' ? 'âš–ï¸' : 'ğŸ§ '}}</text>
        </view>
        <view class="ai-text">
          <text class="ai-title">AI å¥åº·åŠ©æ‰‹</text>
          <text class="ai-message">{{aiInsight.message}}</text>
        </view>
        <view class="ai-priority" wx:if="{{aiInsight.priority === 'high'}}">
          <text class="priority-dot"></text>
        </view>
      </view>
      <view class="ai-close" bindtap="closeAIBanner">
        <text>Ã—</text>
      </view>
    </view>

    <!-- ============ è®¡åˆ’æ¦‚è§ˆå¡ç‰‡ ============ -->
    <view class="plan-overview-card" wx:if="{{activePlan}}">
      <view class="plan-header">
        <view class="plan-title">
          <text class="plan-name">{{activePlan.name || 'å¥åº·è®¡åˆ’'}}</text>
          <view class="plan-status" data-status="{{planProgress.status}}">
            <text class="status-text">{{planProgress.status === 'active' ? 'è¿›è¡Œä¸­' : 'å·²å®Œæˆ'}}</text>
          </view>
        </view>
        <view class="plan-meta">
          <text class="meta-text">å·²è¿›è¡Œ {{planProgress.daysElapsed}} å¤© Â· è¿˜å‰© {{planProgress.daysRemaining}} å¤©</text>
        </view>
      </view>

      <view class="plan-progress">
        <view class="progress-bar-bg">
          <view class="progress-bar-fill" style="width: {{planProgress.completionRate}}%"></view>
        </view>
        <view class="progress-stats">
          <text class="progress-text">{{planProgress.completionRate}}% å®Œæˆ</text>
          <text class="weight-text">ä½“é‡å˜åŒ–: {{planProgress.weightChange > 0 ? '+' : ''}}{{planProgress.weightChange}}kg</text>
        </view>
      </view>
    </view>

    <!-- ============ ä»Šæ—¥ç»¼åˆè¿›åº¦å¡ç‰‡ ============ -->
    <spotlight-card customClass="progress-card" holo="{{true}}" customStyle="background: linear-gradient(135deg, #FFF7ED 0%, #FFEDD5 100%)">
      <view class="progress-content">

        <!-- åŒç¯å½¢å›¾åŒºåŸŸ -->
        <view class="dual-ring-section">
          <!-- é¥®é£Ÿç¯ -->
          <view class="ring-item">
            <view class="ring-wrapper">
              <view class="progress-ring diet-ring">
                <view class="ring-bg"></view>
                <view class="ring-fill" style="background: conic-gradient(#FF6B35 0deg {{dualRingData.dietAngle}}deg, #E5E7EB {{dualRingData.dietAngle}}deg 360deg);"></view>
                <view class="ring-center">
                  <text class="ring-value">{{dualRingData.dietPercentage}}</text>
                  <text class="ring-unit">%</text>
                </view>
              </view>
            </view>
            <view class="ring-info">
              <text class="ring-label">é¥®é£Ÿè¿›åº¦</text>
              <text class="ring-detail">{{todayData.dietCalories}} / {{todayData.targetCalories}}kcal</text>
            </view>
          </view>

          <!-- è¿åŠ¨ç¯ -->
          <view class="ring-item">
            <view class="ring-wrapper">
              <view class="progress-ring exercise-ring">
                <view class="ring-bg"></view>
                <view class="ring-fill" style="background: conic-gradient(#4ECDC4 0deg {{dualRingData.exerciseAngle}}deg, #E5E7EB {{dualRingData.exerciseAngle}}deg 360deg);"></view>
                <view class="ring-center">
                  <text class="ring-value">{{dualRingData.exercisePercentage}}</text>
                  <text class="ring-unit">%</text>
                </view>
              </view>
            </view>
            <view class="ring-info">
              <text class="ring-label">è¿åŠ¨è¿›åº¦</text>
              <text class="ring-detail">{{todayData.exerciseCalories}} / {{todayData.exerciseTargetCalories}}kcal</text>
            </view>
          </view>
        </view>

        <!-- å¹³è¡¡æŒ‡æ ‡ -->
        <view class="balance-indicator">
          <view class="balance-bar">
            <view class="balance-fill" style="width: {{progressMetrics.balanceScore}}%"></view>
          </view>
          <view class="balance-info">
            <text class="balance-label">å¹³è¡¡å¾—åˆ†</text>
            <text class="balance-score">{{progressMetrics.balanceScore}}</text>
          </view>
          <view class="balance-status">
            <text class="status-text" data-status="{{progressMetrics.balanceScore >= 80 ? 'good' : progressMetrics.balanceScore >= 60 ? 'fair' : 'poor'}}">
              {{progressMetrics.balanceScore >= 80 ? 'ä¼˜ç§€' : progressMetrics.balanceScore >= 60 ? 'è‰¯å¥½' : 'éœ€è°ƒæ•´'}}
            </text>
          </view>
        </view>

        <!-- çƒ­é‡å¹³è¡¡çŠ¶æ€ -->
        <view class="calorie-balance">
          <view class="balance-status-card" data-balance="{{todayData.calorieBalance}}">
            <text class="balance-icon">{{todayData.calorieBalance > 0 ? 'ğŸ“ˆ' : todayData.calorieBalance < 0 ? 'ğŸ“‰' : 'âš–ï¸'}}</text>
            <view class="balance-text">
              <text class="balance-title">çƒ­é‡å¹³è¡¡</text>
              <text class="balance-value">
                {{todayData.calorieBalance > 0 ? 'ç›ˆä½™' : todayData.calorieBalance < 0 ? 'èµ¤å­—' : 'å¹³è¡¡'}} {{Math.abs(todayData.calorieBalance)}}kcal
              </text>
            </view>
          </view>
        </view>
      </view>
    </spotlight-card>

    <!-- ============ è¯¦ç»†æŒ‡æ ‡é¢æ¿ ============ -->
    <view class="detailed-metrics">

      <!-- è¥å…»ç´ æŒ‡æ ‡ -->
      <view class="metric-section">
        <view class="section-header">
          <text class="section-title">è¥å…»ç´ æ‘„å…¥</text>
          <view class="section-action" bindtap="onViewNutritionDetail">
            <text class="action-text">è¯¦æƒ…</text>
            <text class="action-arrow">â€º</text>
          </view>
        </view>

        <view class="macros-grid">
          <view class="macro-item" wx:for="{{['protein', 'carbs', 'fat']}}" wx:key="*this">
            <view class="macro-header">
              <text class="macro-name">
                {{item === 'protein' ? 'è›‹ç™½è´¨' : item === 'carbs' ? 'ç¢³æ°´' : 'è„‚è‚ª'}}
              </text>
              <view class="macro-status" data-status="{{macros[item].status}}">
                <text class="status-dot"></text>
              </view>
            </view>
            <view class="macro-progress">
              <view class="progress-bg">
                <view class="progress-fill {{item}}" style="width: {{macros[item].target > 0 ? (macros[item].current / macros[item].target * 100) : 0}}%"></view>
              </view>
              <text class="progress-text">{{macros[item].current}}g / {{macros[item].target}}g</text>
            </view>
          </view>
        </view>
      </view>

      <!-- è¿åŠ¨ç»†åˆ† -->
      <view class="metric-section">
        <view class="section-header">
          <text class="section-title">è¿åŠ¨åˆ†è§£</text>
          <view class="section-action" bindtap="onViewExerciseDetail">
            <text class="action-text">è¯¦æƒ…</text>
            <text class="action-arrow">â€º</text>
          </view>
        </view>

        <view class="exercise-breakdown">
          <view class="exercise-item" wx:for="{{[{key: 'aerobic', name: 'æœ‰æ°§è¿åŠ¨', icon: 'ğŸƒ'}, {key: 'strength', name: 'åŠ›é‡è®­ç»ƒ', icon: 'ğŸ’ª'}, {key: 'flexibility', name: 'æ‹‰ä¼¸æ”¾æ¾', icon: 'ğŸ§˜'}, {key: 'sports', name: 'çƒç±»è¿åŠ¨', icon: 'âš½'}]}}" wx:key="key">
            <view class="exercise-icon">
              <text class="icon-emoji">{{item.icon}}</text>
            </view>
            <view class="exercise-info">
              <text class="exercise-name">{{item.name}}</text>
              <view class="exercise-progress">
                <view class="progress-mini-bg">
                  <view class="progress-mini-fill" style="width: {{exerciseBreakdown[item.key].progress}}%"></view>
                </view>
                <text class="progress-mini-text">{{exerciseBreakdown[item.key].calories}}kcal</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ============ å‘¨åº¦æ¦‚è§ˆ ============ -->
    <view class="weekly-overview">
      <view class="overview-header">
        <text class="overview-title">æœ¬å‘¨æ¦‚è§ˆ</text>
        <view class="overview-stats">
          <text class="stats-text">éµå®ˆç‡ {{weeklyOverview.adherenceRate}}%</text>
          <view class="trend-indicator" data-trend="{{weeklyOverview.trend}}">
            <text class="trend-icon">{{weeklyOverview.trend === 'up' ? 'ğŸ“ˆ' : weeklyOverview.trend === 'down' ? 'ğŸ“‰' : 'â¡ï¸'}}</text>
          </view>
        </view>
      </view>

      <view class="weekly-chart">
        <view class="chart-placeholder">
          <text class="placeholder-text">å‘¨åº¦è¶‹åŠ¿å›¾</text>
          <text class="placeholder-subtext">å±•ç¤º7å¤©çš„æ•°æ®è¶‹åŠ¿</text>
        </view>
      </view>
    </view>

    <!-- å¿«æ·æ“ä½œç½‘æ ¼ -->
    <view class="quick-actions">
      <view class="actions-grid">
        <view
          wx:for="{{quickActions}}"
          wx:key="title"
          class="action-card"
          data-url="{{item.url}}"
          bindtap="onQuickAction"
        >
          <view class="action-icon" style="background: {{item.color}}20">
            <text class="icon-text">{{item.icon}}</text>
          </view>
          <text class="action-title">{{item.title}}</text>
        </view>
      </view>
    </view>

    <!-- AI æ™ºèƒ½åŠ©æ‰‹ -->
    <view class="ai-assistant" bindtap="onAISuggestion">
      <view class="assistant-content">
        <view class="assistant-icon">
          <text class="icon-emoji">ğŸ¤–</text>
        </view>
        <view class="assistant-info">
          <text class="assistant-title">AI å¥åº·åŠ©æ‰‹</text>
          <text class="assistant-desc">è·å–ä¸ªæ€§åŒ–é¥®é£Ÿå’Œè¿åŠ¨å»ºè®®</text>
        </view>
        <view class="assistant-arrow">
          <text class="arrow-icon">â†’</text>
        </view>
      </view>
    </view>

    <!-- æ¨èå†…å®¹ -->
    <view class="recommendations" wx:if="{{recommendations.length > 0}}">
      <view class="section-header">
        <text class="section-title">ä»Šæ—¥æ¨è</text>
        <view class="section-link" bindtap="onRecipeRecommend">
          <text class="link-text">æŸ¥çœ‹æ›´å¤š</text>
          <text class="link-arrow">â€º</text>
        </view>
      </view>

      <scroll-view scroll-x="true" class="recipe-scroll" show-scrollbar="false">
        <view class="recipe-list">
          <view
            wx:for="{{recommendations}}"
            wx:key="id"
            class="recipe-item"
            data-id="{{item.id}}"
            bindtap="viewRecipe"
          >
            <image class="recipe-image" src="{{item.image || '/images/default-goods-image.png'}}" mode="aspectFill" />
            <view class="recipe-overlay">
              <text class="recipe-name">{{item.name}}</text>
              <text class="recipe-calories">{{item.calories}} kcal</text>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-overlay" wx:if="{{loading}}">
      <view class="loading-content">
        <view class="loading-spinner"></view>
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>
    </view>
  </view>
</view>

<!--pages/ai-suggestion/index.wxml-->
<view class="container">

  <!-- åŠ è½½ä¸­ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">AIæ­£åœ¨åˆ†ææ‚¨çš„é¥®é£Ÿæ•°æ®...</text>
  </view>

  <view wx:else>
    
    <!-- AIåˆ†æå¤´éƒ¨ -->
    <view class="ai-header">
      <view class="ai-avatar">ğŸ¤–</view>
      <view class="ai-intro">
        <text class="ai-title">AIè¥å…»å¸ˆ</text>
        <text class="ai-subtitle">åŸºäºæ‚¨è¿‘{{weeklyStats ? weeklyStats.days : 7}}å¤©çš„é¥®é£Ÿæ•°æ®åˆ†æ</text>
      </view>
    </view>

    <!-- AIå»ºè®®å¡ç‰‡ -->
    <view class="suggestions-section">
      <view class="section-title">
        <text class="title-icon">ğŸ’¡</text>
        <text class="title-text">æ™ºèƒ½å»ºè®®</text>
      </view>

      <view class="suggestions-list">
        <view 
          wx:for="{{suggestions}}" 
          wx:key="type"
          class="suggestion-card severity-{{item.severity}}"
        >
          <view class="suggestion-header">
            <text class="suggestion-icon">{{item.icon}}</text>
            <view class="severity-badge severity-{{item.severity}}">
              <text>{{item.severity === 'success' ? 'è‰¯å¥½' : item.severity === 'warning' ? 'æ³¨æ„' : item.severity === 'error' ? 'è­¦å‘Š' : 'æç¤º'}}</text>
            </view>
          </view>
          <text class="suggestion-message">{{item.message}}</text>
        </view>
      </view>
    </view>

    <!-- æ¯å‘¨ç»Ÿè®¡ -->
    <view wx:if="{{weeklyStats}}" class="stats-section">
      <view class="section-title">
        <text class="title-icon">ğŸ“Š</text>
        <text class="title-text">è¿‘{{weeklyStats.days}}å¤©å¹³å‡æ‘„å…¥</text>
      </view>

      <view class="stats-grid">
        <view class="stat-item">
          <text class="stat-label">çƒ­é‡</text>
          <text class="stat-value">{{weeklyStats.avg.calories}}</text>
          <text class="stat-unit">/ {{weeklyStats.goals.calories}}å¡</text>
          <view class="progress-bar">
            <view 
              class="progress-fill" 
              style="width: {{weeklyStats.completion.calories > 100 ? 100 : weeklyStats.completion.calories}}%; background: {{weeklyStats.completion.calories >= 80 && weeklyStats.completion.calories <= 120 ? '#51CF66' : '#FFB84D'}};"
            ></view>
          </view>
          <text class="stat-percentage">{{weeklyStats.completion.calories}}%</text>
        </view>

        <view class="stat-item">
          <text class="stat-label">è›‹ç™½è´¨</text>
          <text class="stat-value">{{weeklyStats.avg.protein}}g</text>
          <text class="stat-unit">/ {{weeklyStats.goals.protein}}g</text>
          <view class="progress-bar">
            <view 
              class="progress-fill" 
              style="width: {{weeklyStats.completion.protein > 100 ? 100 : weeklyStats.completion.protein}}%; background: {{weeklyStats.completion.protein >= 80 && weeklyStats.completion.protein <= 120 ? '#51CF66' : '#FFB84D'}};"
            ></view>
          </view>
          <text class="stat-percentage">{{weeklyStats.completion.protein}}%</text>
        </view>

        <view class="stat-item">
          <text class="stat-label">ç¢³æ°´</text>
          <text class="stat-value">{{weeklyStats.avg.carbs}}g</text>
          <text class="stat-unit">/ {{weeklyStats.goals.carbs}}g</text>
          <view class="progress-bar">
            <view 
              class="progress-fill" 
              style="width: {{weeklyStats.completion.carbs > 100 ? 100 : weeklyStats.completion.carbs}}%; background: {{weeklyStats.completion.carbs >= 80 && weeklyStats.completion.carbs <= 120 ? '#51CF66' : '#FFB84D'}};"
            ></view>
          </view>
          <text class="stat-percentage">{{weeklyStats.completion.carbs}}%</text>
        </view>

        <view class="stat-item">
          <text class="stat-label">è„‚è‚ª</text>
          <text class="stat-value">{{weeklyStats.avg.fat}}g</text>
          <text class="stat-unit">/ {{weeklyStats.goals.fat}}g</text>
          <view class="progress-bar">
            <view 
              class="progress-fill" 
              style="width: {{weeklyStats.completion.fat > 100 ? 100 : weeklyStats.completion.fat}}%; background: {{weeklyStats.completion.fat >= 80 && weeklyStats.completion.fat <= 120 ? '#51CF66' : '#FFB84D'}};"
            ></view>
          </view>
          <text class="stat-percentage">{{weeklyStats.completion.fat}}%</text>
        </view>
      </view>
    </view>

    <!-- æ¨èé£Ÿè°± -->
    <view class="recipes-section">
      <view class="section-title">
        <text class="title-icon">ğŸ½ï¸</text>
        <text class="title-text">ä¸ºæ‚¨æ¨èçš„é£Ÿè°±</text>
      </view>

      <view class="recipes-grid">
        <view 
          wx:for="{{recommendedRecipes}}" 
          wx:key="id"
          class="recipe-mini-card"
          data-id="{{item.id}}"
          bindtap="onRecipeClick"
        >
          <image class="recipe-mini-image" src="{{item.image}}" mode="aspectFill" />
          <view class="recipe-mini-info">
            <text class="recipe-mini-name">{{item.name}}</text>
            <!-- AIæ¨èç†ç”± -->
            <text wx:if="{{item.aiReason}}" class="ai-reason">ğŸ¤– {{item.aiReason}}</text>
            <view class="recipe-mini-nutrition">
              <text class="mini-nutrition-item">ğŸ”¥{{item.calories}}</text>
              <text class="mini-nutrition-item">ğŸ’ª{{item.protein}}g</text>
            </view>
          </view>
        </view>
      </view>

      <button class="btn-view-more" bindtap="onViewMoreRecipes">
        æŸ¥çœ‹æ›´å¤šæ¨è
      </button>
    </view>

    <!-- è¯¦ç»†è¥å…»åˆ†æï¼ˆå¯å±•å¼€ï¼‰ -->
    <view class="detail-analysis-section">
      <view 
        class="detail-analysis-header"
        bindtap="onToggleDetailAnalysis"
      >
        <text class="title-icon">ğŸ“‹</text>
        <text class="title-text">è¯¦ç»†è¥å…»åˆ†æ</text>
        <text class="toggle-icon">{{showDetailAnalysis ? 'â–²' : 'â–¼'}}</text>
      </view>

      <view wx:if="{{showDetailAnalysis}}" class="detail-analysis-content">
        <view class="analysis-item">
          <text class="analysis-label">è›‹ç™½è´¨ç¼ºå£</text>
          <text class="analysis-value {{nutritionGap.proteinDeficit > 0 ? 'deficit' : 'surplus'}}">
            {{nutritionGap.proteinDeficit > 0 ? '-' : '+'}}{{Math.round(nutritionGap.proteinDeficit > 0 ? nutritionGap.proteinDeficit : nutritionGap.proteinExcess)}}g
          </text>
        </view>

        <view class="analysis-item">
          <text class="analysis-label">ç¢³æ°´ç¼ºå£</text>
          <text class="analysis-value {{nutritionGap.carbsDeficit > 0 ? 'deficit' : 'surplus'}}">
            {{nutritionGap.carbsDeficit > 0 ? '-' : '+'}}{{Math.round(nutritionGap.carbsDeficit > 0 ? nutritionGap.carbsDeficit : nutritionGap.carbsExcess)}}g
          </text>
        </view>

        <view class="analysis-item">
          <text class="analysis-label">è„‚è‚ªç¼ºå£</text>
          <text class="analysis-value {{nutritionGap.fatDeficit > 0 ? 'deficit' : 'surplus'}}">
            {{nutritionGap.fatDeficit > 0 ? '-' : '+'}}{{Math.round(nutritionGap.fatDeficit > 0 ? nutritionGap.fatDeficit : nutritionGap.fatExcess)}}g
          </text>
        </view>

        <view class="analysis-item">
          <text class="analysis-label">çƒ­é‡ç¼ºå£</text>
          <text class="analysis-value {{nutritionGap.caloriesDeficit > 0 ? 'deficit' : 'surplus'}}">
            {{nutritionGap.caloriesDeficit > 0 ? '-' : '+'}}{{Math.round(nutritionGap.caloriesDeficit > 0 ? nutritionGap.caloriesDeficit : nutritionGap.caloriesExcess)}}å¡
          </text>
        </view>
      </view>
    </view>

    <!-- åˆ·æ–°æŒ‰é’® -->
    <view class="refresh-section">
      <button class="btn-refresh" bindtap="onRefresh">
        <text class="refresh-icon">ğŸ”„</text>
        <text>é‡æ–°åˆ†æ</text>
      </button>
    </view>

  </view>

</view>


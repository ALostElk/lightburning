<!--
  È•ÆÈ£üËÆ∞ÂΩï‰∏ªÈ°µ - diet/index
  ËÆæËÆ°ËØ≠Ë®Ä: Daylight Futurism (Êó•ÂÖâÊú™Êù•‰∏ª‰πâ)
  ÂäüËÉΩ: ÊäòÂè†È§êÊ¨° + Êó•ÂéÜÈÄâÊã©
-->
<view class="page-container">
  <!-- ============ ‰∏ªÂÜÖÂÆπÂå∫ ============ -->
  <view class="main-content">
    <!-- ============ Êó•ÊúüÂàáÊç¢ÂØºËà™Ê†è ============ -->
    <view class="date-nav-bar">
      <view class="date-nav-arrow" bindtap="goToPrevDay">
        <text class="arrow-icon">‚Äπ</text>
      </view>
      <view class="date-nav-center" bindtap="showCalendar">
        <text class="date-nav-text">{{dateDisplay}}</text>
      </view>
      <view class="date-nav-arrow" bindtap="goToNextDay">
        <text class="arrow-icon">‚Ä∫</text>
      </view>
    </view>

    <!-- AI ÂàÜÊûêÊ®™ÂπÖÔºàÊù°‰ª∂Ê∏≤ÊüìÔºâ -->
    <view class="ai-banner animate-fade-in-up" wx:if="{{aiInsight}}">
      <view class="ai-banner-content">
        <view class="ai-icon-wrapper">
          <text class="ai-icon">üß†</text>
        </view>
        <view class="ai-text">
          <text class="ai-title">AI Êô∫ËÉΩÂàÜÊûê</text>
          <text class="ai-message">{{aiInsight}}</text>
        </view>
      </view>
      <view class="ai-close" bindtap="closeAIBanner">
        <text>√ó</text>
      </view>
    </view>

    <!-- ============ ‰ª™Ë°®ÁõòÂç°Áâá ============ -->
    <spotlight-card customClass="dashboard-card {{dashboardStatus}}" holo="{{true}}">
      <!-- Âä®ÊÄÅÂÖâÊôïÂ±Ç - Áä∂ÊÄÅÊÑüÁü•ÂûãÂëºÂê∏ÂÖâÊôï -->
      <view class="dashboard-glow"></view>
      <view class="dashboard-content">
        <!-- ÁÉ≠ÈáèÁéØÂΩ¢Âõæ + Ê†∏ÂøÉÊï∞ÊçÆ -->
        <view class="calories-dashboard">
            <!-- Liquid Sphere Dashboard -->
            <view class="liquid-sphere">
              <!-- ÁéªÁíÉÁêÉÂÜÖÈÉ®ÂÖâÊôï -->
              <view class="sphere-inner-glow"></view>

              <!-- Ê∂≤‰ΩìÂÆπÂô® - Âè™ÊúâËøõÂ∫¶Â§ß‰∫é0Êó∂ÊâçÊòæÁ§∫Ê∂≤‰Ωì -->
              <view class="liquid-container">
                <view
                  wx:if="{{liquidProgress > 0}}"
                  class="liquid-fluid"
                  style="height: {{liquidProgress}}%"
                >
                  <!-- È¢ùÂ§ñÊ≥¢Êµ™Â±Ç - Áî®‰∫éÊõ¥‰∏∞ÂØåÁöÑÊ≥¢Êµ™ÊïàÊûú -->
                  <view class="wave-layer wave-1"></view>
                  <view class="wave-layer wave-2"></view>
                  <view class="wave-layer wave-3"></view>

                  <!-- Ê∂≤‰ΩìÂÜÖÈÉ®È´òÂÖâ -->
                  <view class="liquid-highlight"></view>
                </view>
              </view>

              <!-- ÁéªÁíÉÁêÉËæπÁºòÂÖâÊ≥Ω -->
              <view class="sphere-rim-light"></view>

              <!-- ‰∏≠ÂøÉÊï∞ÊçÆ -->
              <view class="donut-center">
                <view class="donut-value-wrapper">
                  <text class="donut-value">{{stats.remainingCalories}}</text>
                  <text class="donut-unit">kcal</text>
                </view>
                <text class="donut-label">Ââ©‰Ωô</text>
              </view>
            </view>

          <!-- Âè≥‰æßÔºöËØ¶ÁªÜÊï∞ÊçÆ -->
          <view class="calories-details">
            <view class="calorie-row">
              <view class="calorie-indicator in"></view>
              <text class="calorie-label">Â∑≤ÊëÑÂÖ•</text>
              <view class="calorie-value-wrapper">
                <text class="calorie-value">{{stats.totalCalories}}</text>
                <text class="calorie-unit">kcal</text>
              </view>
            </view>
            <view class="calorie-row">
              <view class="calorie-indicator out"></view>
              <text class="calorie-label">Â∑≤Ê∂àËÄó</text>
              <view class="calorie-value-wrapper">
                <text class="calorie-value">{{stats.burnedCalories}}</text>
                <text class="calorie-unit">kcal</text>
              </view>
            </view>
            <view class="calorie-row goal">
              <view class="calorie-indicator goal-ind"></view>
              <text class="calorie-label">ÁõÆÊ†á</text>
              <view class="calorie-value-wrapper">
                <text class="calorie-value">{{stats.targetCalories}}</text>
                <text class="calorie-unit">kcal</text>
              </view>
            </view>
          </view>
        </view>

        <!-- ÂÆèÈáèËê•ÂÖªÁ¥†Êù° -->
        <view class="macros-section">
          <view class="macro-bar">
            <view class="macro-info">
              <text class="macro-name">Á¢≥Ê∞¥</text>
              <text class="macro-values">{{stats.carbs}}g / {{stats.carbsTarget}}g</text>
            </view>
            <view class="macro-progress-bg">
              <view
                class="macro-progress-fill carbs"
                style="width: {{stats.carbsPercentage > 100 ? 100 : stats.carbsPercentage}}%"
              ></view>
            </view>
          </view>

          <view class="macro-bar">
            <view class="macro-info">
              <text class="macro-name">ËõãÁôΩË¥®</text>
              <text class="macro-values">{{stats.protein}}g / {{stats.proteinTarget}}g</text>
            </view>
            <view class="macro-progress-bg">
              <view
                class="macro-progress-fill protein"
                style="width: {{stats.proteinPercentage > 100 ? 100 : stats.proteinPercentage}}%"
              ></view>
            </view>
          </view>

          <view class="macro-bar">
            <view class="macro-info">
              <text class="macro-name">ËÑÇËÇ™</text>
              <text class="macro-values">{{stats.fat}}g / {{stats.fatTarget}}g</text>
            </view>
            <view class="macro-progress-bg">
              <view
                class="macro-progress-fill fat"
                style="width: {{stats.fatPercentage > 100 ? 100 : stats.fatPercentage}}%"
              ></view>
            </view>
          </view>
        </view>
      </view>
    </spotlight-card>

    <!-- ============ È•ÆÈ£üÊó∂Èó¥Á∫ø ============ -->
    <view class="timeline-section">
      <view class="section-header">
        <text class="section-title">È•ÆÈ£üËÆ∞ÂΩï</text>
        <view class="header-right">
          <!-- ÁºñËæëÊ®°ÂºèÊåâÈíÆ -->
          <view class="edit-btn {{isEditMode ? 'active' : ''}}" catchtap="toggleEditMode">
            <text>{{isEditMode ? 'ÂÆåÊàê' : 'ÁºñËæë'}}</text>
          </view>
        </view>
      </view>

      <!-- Êó∂Èó¥Á∫øÂÆπÂô® -->
      <view class="timeline-container">
        <block wx:for="{{meals}}" wx:key="id">
          <!-- Êó∂Èó¥Á∫øËäÇÁÇπ -->
          <view class="timeline-item">
            <!-- Êó∂Èó¥Á∫ø -->
            <view class="timeline-track">
              <view class="timeline-dot {{item.totalCalories > 0 ? 'active' : ''}}">
                <text class="dot-icon">{{item.emojiIcon}}</text>
              </view>
              <view class="timeline-line" wx:if="{{index < meals.length - 1}}"></view>
            </view>

            <!-- È§êÊ¨°Âç°Áâá -->
            <view class="meal-card-wrapper">
              <spotlight-card
                customClass="meal-card {{item.type}} {{item.totalCalories > 0 ? 'has-data' : ''}}"
                customStyle="{{item.bgStyle}}"
              >
                <!-- ÁÇπÂáªÂç°ÁâáÁ©∫ÁôΩÂå∫ÂüüÂàáÊç¢ÊäòÂè†Áä∂ÊÄÅ -->
                <view class="meal-card-content" bindtap="onMealCardTap" data-mealtype="{{item.type}}">
                  <!-- Âç°ÁâáÂ§¥ÈÉ® -->
                  <view class="meal-header">
                    <view class="meal-title-group">
                      <text class="meal-title">{{item.title}}</text>
                      <text class="meal-time">{{item.suggestMin}}-{{item.suggestMax}} kcal</text>
                    </view>
                    <view class="meal-right-section">
                      <!-- ÂçïÈ§êÁºñËæëÊåâÈíÆ -->
                      <view
                        class="meal-edit-btn {{item.isEditing ? 'active' : ''}}"
                        catchtap="toggleMealEdit"
                        data-mealtype="{{item.type}}"
                        wx:if="{{item.items.length > 0}}"
                      >
                        <text>{{item.isEditing ? 'ÂÆåÊàê' : 'ÁºñËæë'}}</text>
                      </view>
                      <view class="meal-calories" wx:if="{{item.totalCalories > 0}}">
                        <text class="cal-number">{{item.totalCalories}}</text>
                        <text class="cal-unit">kcal</text>
                      </view>
                      <!-- ÊäòÂè†/Â±ïÂºÄÂõæÊ†á - Âè™ÊúâËøôÈáåÂèØ‰ª•ÊäòÂè† -->
                      <view class="collapse-icon {{item.collapsed ? 'collapsed' : ''}}" catchtap="toggleMealCollapse" data-mealtype="{{item.type}}">
                        <text>‚ñº</text>
                      </view>
                    </view>
                  </view>

                  <!-- ËøõÂ∫¶Êù° -->
                  <view class="meal-progress-wrapper">
                    <view class="meal-progress-bar">
                      <view
                        class="meal-progress-fill {{item.percentage > 100 ? 'over' : ''}}"
                        style="width: {{item.percentage > 100 ? 100 : item.percentage}}%"
                      ></view>
                    </view>
                    <text class="meal-progress-text">{{item.percentage}}%</text>
                  </view>

                  <!-- ÂèØÊäòÂè†ÁöÑÈ£üÁâ©ÂàóË°® -->
                  <view class="collapsible-content {{item.collapsed ? 'collapsed' : ''}}">
                    <!-- È£üÁâ©ÂàóË°® -->
                    <view class="food-items" wx:if="{{item.items.length > 0}}">
                      <block wx:for="{{item.items}}" wx:for-item="food" wx:key="uniqueId">
                        <!-- Â∑¶ÊªëÂà†Èô§ÂÆπÂô® -->
                        <view class="food-item-wrapper">
                          <view
                            class="food-item {{food.swiped ? 'swiped' : ''}}"
                            bindtouchstart="onFoodTouchStart"
                            bindtouchmove="onFoodTouchMove"
                            bindtouchend="onFoodTouchEnd"
                            data-id="{{food.id}}"
                            data-mealtype="{{item.type}}"
                          >
                            <!-- ÁºñËæëÊ®°ÂºèÈÄâÊã©Ê°ÜÔºàÂÖ®Â±ÄÊàñÂçïÈ§êÔºâ -->
                            <view class="food-checkbox {{isEditMode || item.isEditing ? 'show' : ''}}" catchtap="toggleFoodSelect" data-id="{{food.id}}" data-mealtype="{{item.type}}">
                              <view class="checkbox-inner {{food.selected ? 'checked' : ''}}">
                                <text wx:if="{{food.selected}}">‚úì</text>
                              </view>
                            </view>
                            <view class="food-left" catchtap="{{isEditMode || item.isEditing ? 'stopPropagation' : 'openFoodEdit'}}" data-food="{{food}}" data-mealtype="{{item.type}}">
                              <text class="food-emoji">{{food.emoji}}</text>
                              <view class="food-info">
                                <text class="food-name">{{food.name}}</text>
                                <text class="food-portion">{{food.portion}}</text>
                              </view>
                            </view>
                            <view class="food-right" catchtap="{{isEditMode || item.isEditing ? 'stopPropagation' : 'openFoodEdit'}}" data-food="{{food}}" data-mealtype="{{item.type}}">
                              <text class="food-cal">{{food.calories}}</text>
                              <text class="food-cal-unit">kcal</text>
                            </view>
                          </view>
                          <!-- Â∑¶ÊªëÂà†Èô§ÊåâÈíÆ -->
                          <view class="swipe-delete-btn" catchtap="deleteSingleFood" data-id="{{food.id}}">
                            <text>Âà†Èô§</text>
                          </view>
                        </view>
                      </block>

                      <!-- Ê∑ªÂä†Êõ¥Â§ö -->
                      <view
                        class="add-meal-btn-large"
                        catchtap="addFood"
                        data-mealtype="{{item.type}}"
                        wx:if="{{!isEditMode && !item.isEditing}}"
                      >
                        <text class="add-icon">+</text>
                        <text class="add-text">Ê∑ªÂä†{{item.title}}</text>
                      </view>
                    </view>

                    <!-- Á©∫Áä∂ÊÄÅ -->
                    <view class="empty-state" wx:if="{{item.items.length === 0}}">
                      <text class="empty-hint">{{item.emptyText}}</text>
                      <view
                        class="add-meal-btn-large"
                        catchtap="addFood"
                        data-mealtype="{{item.type}}"
                      >
                        <text class="add-icon">+</text>
                        <text class="add-text">Ê∑ªÂä†{{item.title}}</text>
                      </view>
                    </view>
                  </view>
                </view>
              </spotlight-card>
            </view>
          </view>
        </block>
      </view>
    </view>

    <!-- Â∫ïÈÉ®ÂÆâÂÖ®Âå∫Âüü -->
    <view class="bottom-spacer"></view>
  </view>

  <!-- ============ ÊâπÈáèÊìç‰ΩúÊ†è ============ -->
  <view class="batch-action-bar {{(isEditMode || hasAnyMealEditing) && selectedCount > 0 ? 'show' : ''}}">
    <view class="batch-info">
      <text class="selected-count">Â∑≤ÈÄâÊã© {{selectedCount}} È°π</text>
      <text class="selected-calories">ÂÖ± {{selectedCalories}} kcal</text>
    </view>
    <view class="batch-actions">
      <view class="batch-btn select-all" catchtap="toggleSelectAll">
        <text>{{isAllSelected ? 'ÂèñÊ∂àÂÖ®ÈÄâ' : 'ÂÖ®ÈÄâ'}}</text>
      </view>
      <view class="batch-btn delete" catchtap="deleteSelectedFoods">
        <text>Âà†Èô§</text>
      </view>
    </view>
  </view>

  <!-- ============ ÊµÆÂä®Áõ∏Êú∫ÊåâÈíÆ ============ -->
  <view class="camera-glass-btn" bindtap="goToCamera">
    <view class="crystal-camera-body">
      <view class="crystal-camera-lens"></view>
      <view class="crystal-camera-flash"></view>
    </view>
  </view>

  <!-- ============ Êó•ÂéÜÈÄâÊã©Âô®ÂºπÁ™ó ============ -->
  <view class="calendar-modal {{showCalendarModal ? 'show' : ''}}" catchtap="hideCalendar">
    <view class="calendar-content" catchtap="stopPropagation">
      <view class="calendar-header">
        <view class="calendar-nav" bindtap="prevMonth">
          <text>‚Äπ</text>
        </view>
        <text class="calendar-title">{{calendarYear}}Âπ¥{{calendarMonth}}Êúà</text>
        <view class="calendar-nav" bindtap="nextMonth">
          <text>‚Ä∫</text>
        </view>
      </view>

      <!-- ÊòüÊúüÂ§¥ -->
      <view class="calendar-weekdays">
        <text class="weekday">Êó•</text>
        <text class="weekday">‰∏Ä</text>
        <text class="weekday">‰∫å</text>
        <text class="weekday">‰∏â</text>
        <text class="weekday">Âõõ</text>
        <text class="weekday">‰∫î</text>
        <text class="weekday">ÂÖ≠</text>
      </view>

      <!-- Êó•ÊúüÁΩëÊ†º -->
      <view class="calendar-days">
        <block wx:for="{{calendarDays}}" wx:key="date">
          <view
            class="calendar-day {{item.isCurrentMonth ? '' : 'other-month'}} {{item.isToday ? 'today' : ''}} {{item.isSelected ? 'selected' : ''}} {{item.hasRecord ? 'has-record' : ''}} {{item.isFuture ? 'future' : ''}}"
            bindtap="{{item.isFuture ? '' : 'selectCalendarDay'}}"
            data-date="{{item.date}}"
          >
            <text class="day-number">{{item.day}}</text>
            <view class="record-dot" wx:if="{{item.hasRecord}}"></view>
          </view>
        </block>
      </view>

      <!-- Âø´Êç∑ÈÄâÈ°π -->
      <view class="calendar-shortcuts">
        <view class="shortcut-btn" bindtap="selectToday">‰ªäÂ§©</view>
        <view class="shortcut-btn" bindtap="selectYesterday">Êò®Â§©</view>
        <view class="shortcut-btn" bindtap="selectThisWeek">Êú¨Âë®</view>
      </view>
    </view>
  </view>

  <!-- ============ Âä†ËΩΩÈÅÆÁΩ© ============ -->
  <view class="loading-overlay" wx:if="{{isLoading}}">
    <view class="loading-content">
      <view class="loading-spinner"></view>
      <text class="loading-text">Âä†ËΩΩ‰∏≠...</text>
    </view>
  </view>

  <!-- ============ È£üÁâ©ÁºñËæëÂºπÁ™ó ============ -->
  <view class="food-edit-modal {{showFoodEditModal ? 'show' : ''}}" catchtap="closeFoodEdit">
    <view class="food-edit-content" catchtap="stopPropagation">
      <!-- ÂºπÁ™óÂ§¥ÈÉ® -->
      <view class="food-edit-header">
        <text class="food-edit-title">ÁºñËæëÈ£üÁâ©</text>
        <view class="food-edit-close" bindtap="closeFoodEdit">
          <text>√ó</text>
        </view>
      </view>

      <!-- È£üÁâ©‰ø°ÊÅØ -->
      <view class="food-edit-info">
        <view class="food-edit-avatar">
          <text class="food-edit-emoji">{{editingFood.emoji || 'üçΩÔ∏è'}}</text>
        </view>
        <view class="food-edit-name">{{editingFood.name}}</view>
      </view>

      <!-- ÂÖãÊï∞ËæìÂÖ• -->
      <view class="food-edit-form">
        <!-- ‰ªΩÈáèÊòæÁ§∫ -->
        <view class="amount-header">
          <text class="form-label">ÈÄâÊã©‰ªΩÈáè</text>
          <view class="amount-display">
            <text class="amount-value">{{editingFood.grams}}</text>
            <text class="amount-unit-text">ÂÖã</text>
          </view>
        </view>

        <!-- ÊªëÂä®Êù°Âå∫Âüü -->
        <view class="slider-container">
          <view class="slider-track">
            <view class="slider-fill" style="width: {{(editingFood.grams / 500) * 100}}%"></view>
          </view>
          <slider class="amount-slider"
                  min="10"
                  max="500"
                  step="5"
                  value="{{editingFood.grams}}"
                  activeColor="transparent"
                  backgroundColor="transparent"
                  block-size="0"
                  bindchange="onSliderChange"
                  bindchanging="onSliderChanging" />
          <!-- ÊªëÂùóÂõæÊ†á -->
          <view class="slider-thumb" style="left: {{(editingFood.grams / 500) * 100}}%">
            <view class="thumb-icon">
              <text>{{editingFood.emoji || 'üçΩÔ∏è'}}</text>
            </view>
          </view>
          <!-- ÂàªÂ∫¶Ê†áËÆ∞ -->
          <view class="slider-marks">
            <text class="mark">10g</text>
            <text class="mark">250g</text>
            <text class="mark">500g</text>
          </view>
        </view>

        <!-- Âø´Êç∑‰ªΩÈáèÈÄâÊã© -->
        <view class="quick-grams">
          <view class="quick-grams-label">Âø´Êç∑ÈÄâÊã©</view>
          <view class="quick-grams-btns">
            <view class="quick-gram-btn" bindtap="setQuickGrams" data-grams="50">50g</view>
            <view class="quick-gram-btn" bindtap="setQuickGrams" data-grams="100">100g</view>
            <view class="quick-gram-btn" bindtap="setQuickGrams" data-grams="150">150g</view>
            <view class="quick-gram-btn" bindtap="setQuickGrams" data-grams="200">200g</view>
            <view class="quick-gram-btn" bindtap="setQuickGrams" data-grams="250">250g</view>
            <view class="quick-gram-btn" bindtap="setQuickGrams" data-grams="300">300g</view>
          </view>
        </view>

        <!-- ÁÉ≠ÈáèÈ¢ÑËßà -->
        <view class="calories-preview">
          <view class="preview-row">
            <text class="preview-label">ÁÉ≠Èáè</text>
            <text class="preview-value">{{editingFood.calculatedCalories || 0}} kcal</text>
          </view>
          <view class="preview-row">
            <text class="preview-label">ËõãÁôΩË¥®</text>
            <text class="preview-value protein">{{editingFood.calculatedProtein || 0}}g</text>
          </view>
          <view class="preview-row">
            <text class="preview-label">Á¢≥Ê∞¥</text>
            <text class="preview-value carbs">{{editingFood.calculatedCarbs || 0}}g</text>
          </view>
          <view class="preview-row">
            <text class="preview-label">ËÑÇËÇ™</text>
            <text class="preview-value fat">{{editingFood.calculatedFat || 0}}g</text>
          </view>
        </view>
      </view>

      <!-- Êìç‰ΩúÊåâÈíÆ -->
      <view class="food-edit-actions">
        <view class="edit-btn-cancel" bindtap="closeFoodEdit">ÂèñÊ∂à</view>
        <view class="edit-btn-save" bindtap="saveFoodEdit">‰øùÂ≠ò‰øÆÊîπ</view>
      </view>
    </view>
  </view>
</view>

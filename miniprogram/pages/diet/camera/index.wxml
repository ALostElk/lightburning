<!--
  æ‹ç…§è¯†åˆ«é¡µé¢ - diet-camera/index
  è®¾è®¡è¯­è¨€: Daylight Futurism (æ—¥å…‰æœªæ¥ä¸»ä¹‰)
  é›†æˆäº‘å‡½æ•°: dietService (recognizeAndSearch)
-->
<view class="page-container">
  <!-- ============ è‡ªå®šä¹‰å¯¼èˆªæ  ============ -->
  <view class="nav-header" style="padding-top: {{statusBarHeight}}px;">
    <view class="nav-content">
      <view class="nav-back" bindtap="goBack">
        <text class="back-icon">â€¹</text>
      </view>
      <text class="nav-title">AI æ™ºèƒ½è¯†åˆ«</text>
      <view class="nav-placeholder"></view>
    </view>
  </view>

  <!-- ============ ä¸»å†…å®¹åŒº ============ -->
  <view class="main-content">
    <!-- ====== æœªæ‹ç…§çŠ¶æ€ï¼šä¸Šä¼ åŒºåŸŸ ====== -->
    <view wx:if="{{!imagePreview}}" class="upload-section animate-fade-in">
      <spotlight-card customClass="upload-card" holo="{{true}}">
        <view class="upload-card-content">
          <!-- å›¾æ ‡åŒºåŸŸ -->
          <view class="upload-icon-wrapper">
            <view class="upload-icon-bg">
              <text class="upload-icon">âœ¨</text>
            </view>
            <!-- è„‰å†²å…‰ç¯ -->
            <view class="pulse-ring pulse-ring-1"></view>
            <view class="pulse-ring pulse-ring-2"></view>
          </view>

          <!-- æ ‡é¢˜æè¿° -->
          <view class="upload-text">
            <text class="upload-title">AI æ™ºèƒ½è¯†åˆ«</text>
            <text class="upload-desc">æ‹æ‘„æˆ–ä¸Šä¼ é£Ÿç‰©ç…§ç‰‡ï¼Œè‡ªåŠ¨è¯†åˆ«å¹¶è®¡ç®—çƒ­é‡</text>
          </view>

          <!-- æ“ä½œæŒ‰é’® -->
          <view class="upload-actions">
            <view class="action-btn primary" bindtap="chooseImage" data-source="camera">
              <view class="action-btn-inner">
                <text class="action-icon">ğŸ“·</text>
                <text class="action-text">æ‹ç…§è¯†åˆ«</text>
              </view>
              <view class="btn-glow"></view>
            </view>

            <view class="action-btn secondary" bindtap="chooseImage" data-source="album">
              <view class="action-btn-inner">
                <text class="action-icon">ğŸ–¼ï¸</text>
                <text class="action-text">ä»ç›¸å†Œé€‰æ‹©</text>
              </view>
              <view class="btn-glow blue"></view>
            </view>
          </view>
        </view>
      </spotlight-card>

      <!-- æç¤ºæ–‡å­— -->
      <view class="tips-section">
        <view class="tip-item">
          <text class="tip-icon">ğŸ’¡</text>
          <text class="tip-text">ç¡®ä¿é£Ÿç‰©åœ¨ç”»é¢ä¸­æ¸…æ™°å¯è§</text>
        </view>
        <view class="tip-item">
          <text class="tip-icon">â˜€ï¸</text>
          <text class="tip-text">å…‰çº¿å……è¶³çš„ç¯å¢ƒè¯†åˆ«æ•ˆæœæ›´ä½³</text>
        </view>
      </view>
    </view>

    <!-- ====== å·²æ‹ç…§çŠ¶æ€ï¼šç»“æœåŒºåŸŸ ====== -->
    <view wx:else class="result-section">
      <!-- å›¾ç‰‡é¢„è§ˆå¡ç‰‡ -->
      <spotlight-card customClass="preview-card {{isAnalyzing ? 'analyzing' : ''}}" theme="primary">
        <!-- æ—‹è½¬å…‰è¾¹æ•ˆæœ -->
        <view class="beam-border {{isAnalyzing ? 'active' : ''}}">
          <view class="rotating-beam"></view>
        </view>
        <view class="preview-wrapper">
          <image
            src="{{imagePreview}}"
            mode="aspectFill"
            class="preview-image"
          />

          <!-- åˆ†æä¸­é®ç½© -->
          <view wx:if="{{isAnalyzing}}" class="analyzing-overlay">
            <view class="analyzing-content">
              <view class="analyzing-spinner">
                <view class="spinner-ring"></view>
                <text class="spinner-icon">ğŸ”</text>
              </view>
              <text class="analyzing-text">AI åˆ†æä¸­...</text>
              <view class="analyzing-progress">
                <view class="progress-bar"></view>
              </view>
            </view>
          </view>

          <!-- é‡æ‹æŒ‰é’® -->
          <view class="retake-btn" bindtap="retake">
            <text class="retake-icon">âœ•</text>
          </view>

          <!-- å›¾ç‰‡æ ‡ç­¾ -->
          <view class="image-badge" wx:if="{{!isAnalyzing && recognizedFoods.length > 0}}">
            <text class="badge-icon">âœ“</text>
            <text class="badge-text">è¯†åˆ«å®Œæˆ</text>
          </view>
        </view>
      </spotlight-card>

      <!-- é”™è¯¯æç¤º -->
      <view wx:if="{{error}}" class="error-banner animate-shake">
        <view class="error-content">
          <text class="error-icon">âš ï¸</text>
          <text class="error-text">{{error}}</text>
        </view>
        <view class="error-action" bindtap="retake">
          <text>é‡è¯•</text>
        </view>
      </view>

      <!-- è¯†åˆ«ç»“æœå¡ç‰‡ -->
      <spotlight-card
        wx:if="{{recognizedFoods.length > 0}}"
        customClass="results-card animate-slide-up"
        holo="{{true}}"
      >
        <view class="results-content">
          <!-- ç»“æœå¤´éƒ¨ -->
          <view class="results-header">
            <view class="results-title-group">
              <text class="results-title">è¯†åˆ«ç»“æœ</text>
              <view class="results-badge">
                <text>{{recognizedFoods.length}}</text>
              </view>
            </view>
            <text class="results-subtitle">ç‚¹å‡»é€‰æ‹©éœ€è¦æ·»åŠ çš„é£Ÿç‰©</text>
          </view>

          <!-- é£Ÿç‰©åˆ—è¡¨ -->
          <view class="food-list">
            <view
              wx:for="{{recognizedFoods}}"
              wx:key="index"
              class="food-item {{selectedFoods[index] ? 'selected' : ''}}"
            >
              <!-- é£Ÿç‰©å¤´éƒ¨ - å¯ç‚¹å‡»é€‰æ‹© -->
              <view class="food-header" bindtap="toggleFood" data-index="{{index}}">
                <!-- é€‰æ‹©æŒ‡ç¤ºå™¨ -->
                <view class="food-checkbox {{selectedFoods[index] ? 'checked' : ''}}">
                  <text wx:if="{{selectedFoods[index]}}" class="check-icon">âœ“</text>
                </view>

                <!-- é£Ÿç‰©ä¿¡æ¯ -->
                <view class="food-info">
                  <view class="food-name-row">
                    <text class="food-name">{{item.name}}</text>
                    <view wx:if="{{item.confidence}}" class="confidence-tag">
                      <text>{{item.confidence * 100}}%</text>
                    </view>
                  </view>
                  <view class="food-meta">
                    <text class="food-category">{{item.category || 'æœªåˆ†ç±»'}}</text>
                    <text class="food-dot">Â·</text>
                    <text class="food-cal-base">{{item.calories}} kcal/100g</text>
                  </view>
                </view>

                <!-- çƒ­é‡æ˜¾ç¤º -->
                <view class="food-calories" wx:if="{{selectedFoods[index]}}">
                  <text class="cal-value">{{item.calories * (foodAmounts[index] || 100) / 100}}</text>
                  <text class="cal-unit">kcal</text>
                </view>
              </view>

              <!-- ä»½é‡è°ƒæ•´åŒºåŸŸ - ä»…é€‰ä¸­æ—¶æ˜¾ç¤º -->
              <view wx:if="{{selectedFoods[index]}}" class="amount-section">
                <view class="amount-row">
                  <text class="amount-label">ä»½é‡è°ƒæ•´</text>
                  <view class="amount-controls">
                    <view
                      class="amount-btn minus"
                      bindtap="adjustAmount"
                      data-index="{{index}}"
                      data-delta="{{-10}}"
                    >
                      <text>âˆ’</text>
                    </view>
                    <view class="amount-display">
                      <text class="amount-value">{{foodAmounts[index] || 100}}</text>
                      <text class="amount-unit">g</text>
                    </view>
                    <view
                      class="amount-btn plus"
                      bindtap="adjustAmount"
                      data-index="{{index}}"
                      data-delta="{{10}}"
                    >
                      <text>+</text>
                    </view>
                  </view>
                </view>

                <!-- è¥å…»è¯¦æƒ… -->
                <view class="nutrition-details">
                  <view class="nutrition-item protein">
                    <text class="nutrition-label">è›‹ç™½è´¨</text>
                    <text class="nutrition-value">{{item.protein * (foodAmounts[index] || 100) / 100}}g</text>
                  </view>
                  <view class="nutrition-item carbs">
                    <text class="nutrition-label">ç¢³æ°´</text>
                    <text class="nutrition-value">{{item.carbs * (foodAmounts[index] || 100) / 100}}g</text>
                  </view>
                  <view class="nutrition-item fat">
                    <text class="nutrition-label">è„‚è‚ª</text>
                    <text class="nutrition-value">{{item.fat * (foodAmounts[index] || 100) / 100}}g</text>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </spotlight-card>

      <!-- é¤æ¬¡é€‰æ‹©å¡ç‰‡ -->
      <spotlight-card
        wx:if="{{recognizedFoods.length > 0}}"
        customClass="meal-card animate-slide-up"
      >
        <view class="meal-content">
          <view class="meal-header">
            <text class="meal-label">æ·»åŠ åˆ°</text>
            <view class="meal-selector" bindtap="toggleMealTypeSelector">
              <text class="meal-emoji">{{mealEmojis[selectedMealType]}}</text>
              <text class="meal-name">{{mealTypeLabels[selectedMealType]}}</text>
              <text class="meal-arrow {{showMealTypeSelector ? 'up' : ''}}">â€º</text>
            </view>
          </view>

          <!-- é¤æ¬¡é€‰é¡¹ -->
          <view wx:if="{{showMealTypeSelector}}" class="meal-options">
            <view
              wx:for="{{['breakfast', 'lunch', 'dinner', 'snack']}}"
              wx:key="*this"
              class="meal-option {{selectedMealType === item ? 'active' : ''}}"
              bindtap="selectMealType"
              data-type="{{item}}"
            >
              <text class="option-emoji">{{mealEmojis[item]}}</text>
              <text class="option-name">{{mealTypeLabels[item]}}</text>
            </view>
          </view>
        </view>
      </spotlight-card>

      <!-- æ‘˜è¦ä¸æäº¤ -->
      <view wx:if="{{recognizedFoods.length > 0 && hasSelectedFoods}}" class="summary-section animate-slide-up">
        <spotlight-card customClass="summary-card" theme="primary">
          <view class="summary-content">
            <!-- æ‘˜è¦ä¿¡æ¯ -->
            <view class="summary-stats">
              <view class="summary-left">
                <text class="summary-label">å·²é€‰æ‹©</text>
                <text class="summary-count">{{selectedCount}} é¡¹</text>
              </view>
              <view class="summary-right">
                <text class="summary-total">{{totalCalories}}</text>
                <text class="summary-unit">kcal</text>
              </view>
            </view>

            <!-- è¥å…»æ±‡æ€» -->
            <view class="summary-macros">
              <view class="macro-item">
                <view class="macro-dot protein"></view>
                <text class="macro-text">è›‹ç™½è´¨ {{totalProtein}}g</text>
              </view>
              <view class="macro-item">
                <view class="macro-dot carbs"></view>
                <text class="macro-text">ç¢³æ°´ {{totalCarbs}}g</text>
              </view>
              <view class="macro-item">
                <view class="macro-dot fat"></view>
                <text class="macro-text">è„‚è‚ª {{totalFat}}g</text>
              </view>
            </view>
          </view>
        </spotlight-card>

        <!-- æäº¤æŒ‰é’® -->
        <glow-button
          title="{{isSubmitting ? 'ä¿å­˜ä¸­...' : 'ç¡®è®¤æ·»åŠ '}}"
          subtitle="{{selectedCount}} é¡¹é£Ÿç‰©å°†æ·»åŠ åˆ°{{mealTypeLabels[selectedMealType]}}"
          loading="{{isSubmitting}}"
          bindtap="submit"
        />
      </view>
    </view>

    <!-- æ‰‹åŠ¨æœç´¢é“¾æ¥ -->
    <view class="manual-search" bindtap="goToSearch">
      <text class="search-hint">è¯†åˆ«ä¸å‡†ç¡®ï¼Ÿ</text>
      <text class="search-link">æ‰‹åŠ¨æœç´¢æ·»åŠ </text>
      <text class="search-arrow">â†’</text>
    </view>
  </view>
</view>

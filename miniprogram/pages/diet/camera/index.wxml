<!--
  拍照识别页面 - diet-camera/index
  设计语言: Daylight Futurism (日光未来主义)
  全屏沉浸式相机界面 - "先拍照，后确认/补录"
-->
<view class="camera-page">
  <!-- ============ 返回按钮 ============ -->
  <view class="nav-back-btn" bindtap="goBack" style="top: {{statusBarHeight}}px">
    <text class="back-arrow">‹</text>
  </view>

  <!-- ============ 取景页 ============ -->
  <block wx:if="{{!showResult}}">
    <camera 
      class="fullscreen-camera" 
      mode="normal" 
      device-position="back" 
      flash="off"
      bindinitdone="onCameraInit"
      binderror="onCameraError"
    >
      <!-- 扫描框 HUD -->
      <cover-view class="scan-area">
        <cover-view class="scan-corner top-left"></cover-view>
        <cover-view class="scan-corner top-right"></cover-view>
        <cover-view class="scan-corner bottom-left"></cover-view>
        <cover-view class="scan-corner bottom-right"></cover-view>
        <cover-view class="scan-line"></cover-view>
      </cover-view>
      
      <!-- 引导区 -->
      <cover-view class="guide-area">
        <cover-view class="guide-text">将食物放入框内，自动识别</cover-view>
      </cover-view>
    </camera>

    <!-- 底部控制台 -->
    <view class="bottom-console">
      <view class="control-btn text-btn" bindtap="chooseImage">
        <text class="btn-text">相册</text>
      </view>

      <view class="shutter-btn-wrapper" bindtap="takePhoto">
        <view class="shutter-outer-ring"></view>
        <view class="shutter-inner-core"></view>
      </view>

      <view class="control-btn text-btn" bindtap="goBack">
        <text class="btn-text">取消</text>
      </view>
    </view>
  </block>

  <!-- ============ Loading 层 ============ -->
  <view class="analyzing-overlay" wx:if="{{isAnalyzing}}">
    <image class="overlay-bg" src="{{tempImagePath}}" mode="aspectFill" />
    <view class="overlay-blur"></view>
    <view class="radar-scan"></view>
    <text class="analyzing-text">AI 正在识别热量...</text>
  </view>

  <!-- ============ 结果确认页 ============ -->
  <view class="result-layer" wx:if="{{showResult}}">
    <!-- 返回按钮 -->
    <view class="nav-back-btn" bindtap="goBack" style="top: {{statusBarHeight}}px">
      <text class="back-arrow">‹</text>
    </view>

    <!-- 背景图片 -->
    <image class="result-bg" src="{{tempImagePath}}" mode="aspectFill" />
    <!-- 背景模糊遮罩 -->
    <view class="result-bg-blur"></view>
    
    <!-- 结果卡片 -->
    <view class="result-card animate-slide-up">
      <view class="card-header">
        <text class="card-title">识别结果</text>
        <view class="card-close" bindtap="retakePhoto">重拍</view>
      </view>

      <!-- 餐次选择器 -->
      <view class="meal-selector-row">
        <view class="meal-label">添加到：</view>
        <view class="meal-chips">
          <block wx:for="{{mealTypes}}" wx:key="key">
            <view class="meal-chip {{selectedMealType === item.key ? 'active' : ''}}" bindtap="selectMeal" data-type="{{item.key}}">
              {{item.name}}
            </view>
          </block>
        </view>
      </view>

      <scroll-view scroll-y class="food-list" style="max-height: 50vh;">
        <block wx:for="{{recognizedFoods}}" wx:key="index">
          <view class="food-item">
            <view class="food-left">
              <view class="food-emoji css-icon-food {{item.isSelected ? 'selected' : ''}}" catchtap="toggleSelection" data-index="{{index}}"></view>
              <view class="food-info" bindtap="openFoodEdit" data-index="{{index}}">
                <text class="food-name">{{item.name}}</text>
                <view class="food-sub-info">
                  <text class="food-grams">{{item.grams || 100}}g</text>
                  <text class="food-macros">P:{{item.protein || 0}} C:{{item.carbs || 0}} F:{{item.fat || 0}}</text>
                </view>
              </view>
            </view>
            <view class="food-right" bindtap="openFoodEdit" data-index="{{index}}">
              <text class="food-cal">{{item.calories || 0}}</text>
              <text class="food-unit">kcal</text>
            </view>
            <view class="food-delete" catchtap="removeFood" data-index="{{index}}">×</view>
          </view>
        </block>

        <!-- 手动添加按钮 -->
        <view class="manual-add-row text-only" bindtap="goToSearch">
          <text class="add-text">识别不准？手动搜索 ></text>
        </view>
      </scroll-view>

      <view class="card-footer">
        <view class="total-cal">
          <text class="total-label">总计热量</text>
          <text class="total-num">{{totalCalories}}</text>
        </view>
        <view class="save-btn" bindtap="saveAll">
          <text>确认记录</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ============ 食物编辑弹窗 ============ -->
  <view class="food-edit-modal {{showFoodEditModal ? 'show' : ''}}" catchtap="closeFoodEdit">
    <view class="food-edit-content" catchtap="stopPropagation">
      <view class="food-edit-header">
        <text class="food-edit-title">调整份量</text>
        <view class="food-edit-close" bindtap="closeFoodEdit">×</view>
      </view>

      <view class="food-edit-info">
        <view class="food-edit-name">{{editingFood.name}}</view>
      </view>

      <view class="slider-container">
        <view class="slider-header">
          <text>摄入量</text>
          <text class="slider-value">{{editingFood.grams || 100}}g</text>
        </view>
        <slider 
          class="amount-slider" 
          min="10" 
          max="500" 
          step="5" 
          value="{{editingFood.grams || 100}}" 
          activeColor="#FF6B35" 
          bindchanging="onSliderChange" 
          bindchange="onSliderChange"
        />
      </view>

      <view class="calories-preview">
        <view class="preview-item">
          <text class="p-label">热量</text>
          <text class="p-val">{{editingFood.calories || 0}}</text>
        </view>
        <view class="preview-item">
          <text class="p-label">蛋白质</text>
          <text class="p-val protein">{{editingFood.protein || 0}}g</text>
        </view>
        <view class="preview-item">
          <text class="p-label">碳水</text>
          <text class="p-val carbs">{{editingFood.carbs || 0}}g</text>
        </view>
        <view class="preview-item">
          <text class="p-label">脂肪</text>
          <text class="p-val fat">{{editingFood.fat || 0}}g</text>
        </view>
      </view>

      <view class="food-edit-actions">
        <view class="edit-btn-save" bindtap="saveFoodEdit">确认修改</view>
      </view>
    </view>
  </view>
</view>

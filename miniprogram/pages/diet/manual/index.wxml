<!--
  æ‰‹åŠ¨è¾“å…¥é¡µé¢ - diet-manual/index
-->
<view class="page">
  <!-- èƒŒæ™¯è£…é¥° -->
  <view class="page-bg"></view>

  <!-- æ‚¬æµ®è¿”å›æŒ‰é’® -->
  <view class="nav-back-btn" bindtap="goBack" style="top: {{statusBarHeight}}px">
    <text class="back-arrow">â€¹</text>
  </view>

  <!-- å¤´éƒ¨ -->
  <view class="header">
    <text class="header-title">{{isManualMode ? 'æ‰‹åŠ¨æ·»åŠ ' : 'ç¡®è®¤ä»½é‡'}}</text>
    <view class="header-placeholder"></view>
  </view>

  <view class="content">
    <!-- é£Ÿç‰©ä¿¡æ¯å¡ç‰‡ -->
    <view class="info-card">
      <view class="food-header">
        <view class="food-emoji">ğŸ½ï¸</view>
        <view class="food-name-section">
          <input wx:if="{{isManualMode}}"
                 class="name-input"
                 value="{{name}}"
                 placeholder="è¾“å…¥é£Ÿç‰©åç§°"
                 bindinput="onNameInput" />
          <text wx:else class="food-name">{{name}}</text>
          <text wx:if="{{food.category}}" class="food-category">{{food.category}}</text>
        </view>
      </view>

      <!-- åŸºç¡€è¥å…»ä¿¡æ¯ -->
      <view class="base-nutrition">
        <view class="base-label">æ¯ 100g è¥å…»æˆåˆ†</view>
        <view class="base-values">
          <view class="base-item">
            <text class="base-value orange">{{baseNutrition.calories}}</text>
            <text class="base-unit">åƒå¡</text>
          </view>
          <view class="base-item">
            <text class="base-value blue">{{baseNutrition.protein}}g</text>
            <text class="base-unit">è›‹ç™½è´¨</text>
          </view>
          <view class="base-item">
            <text class="base-value amber">{{baseNutrition.carbs}}g</text>
            <text class="base-unit">ç¢³æ°´</text>
          </view>
          <view class="base-item">
            <text class="base-value purple">{{baseNutrition.fat}}g</text>
            <text class="base-unit">è„‚è‚ª</text>
          </view>
        </view>
      </view>

      <!-- æ‰‹åŠ¨è¾“å…¥è¥å…» -->
      <view wx:if="{{isManualMode}}" class="manual-nutrition">
        <view class="manual-label">è¥å…»æˆåˆ†ï¼ˆæ¯100gï¼‰</view>
        <view class="manual-inputs">
          <view class="manual-input-item">
            <text class="input-label">çƒ­é‡ (kcal)</text>
            <input class="nutrition-input"
                   type="digit"
                   value="{{baseNutrition.calories || ''}}"
                   placeholder="0"
                   data-field="calories"
                   bindinput="onNutritionInput" />
          </view>
          <view class="manual-input-item">
            <text class="input-label">è›‹ç™½è´¨ (g)</text>
            <input class="nutrition-input"
                   type="digit"
                   value="{{baseNutrition.protein || ''}}"
                   placeholder="0"
                   data-field="protein"
                   bindinput="onNutritionInput" />
          </view>
          <view class="manual-input-item">
            <text class="input-label">ç¢³æ°´åŒ–åˆç‰© (g)</text>
            <input class="nutrition-input"
                   type="digit"
                   value="{{baseNutrition.carbs || ''}}"
                   placeholder="0"
                   data-field="carbs"
                   bindinput="onNutritionInput" />
          </view>
          <view class="manual-input-item">
            <text class="input-label">è„‚è‚ª (g)</text>
            <input class="nutrition-input"
                   type="digit"
                   value="{{baseNutrition.fat || ''}}"
                   placeholder="0"
                   data-field="fat"
                   bindinput="onNutritionInput" />
          </view>
        </view>
      </view>
    </view>

    <!-- ä»½é‡é€‰æ‹© - æ»‘åŠ¨æ¡ç‰ˆæœ¬ -->
    <view class="amount-card">
      <view class="amount-header">
        <view class="amount-label">é€‰æ‹©ä»½é‡</view>
        <view class="amount-display">
          <text class="amount-value">{{amount}}</text>
          <text class="amount-unit-text">å…‹</text>
        </view>
      </view>

      <!-- æ»‘åŠ¨æ¡åŒºåŸŸ -->
      <view class="slider-container">
        <view class="slider-track">
          <view class="slider-fill" style="width: {{(amount / 500) * 100}}%"></view>
        </view>
        <slider class="amount-slider"
                min="10"
                max="500"
                step="5"
                value="{{amount}}"
                activeColor="transparent"
                backgroundColor="transparent"
                block-size="0"
                bindchange="onSliderChange"
                bindchanging="onSliderChanging" />
        <!-- æ»‘å—å›¾æ ‡ - æ ¹æ®é£Ÿç‰©ç±»å‹å˜åŒ– -->
        <view class="slider-thumb" style="left: {{(amount / 500) * 100}}%">
          <view class="thumb-icon">
            <text wx:if="{{food.category === 'ä¸»é£Ÿ'}}">ğŸš</text>
            <text wx:elif="{{food.category === 'è‚‰ç±»'}}">ğŸ¥©</text>
            <text wx:elif="{{food.category === 'è›‹å¥¶'}}">ğŸ¥š</text>
            <text wx:elif="{{food.category === 'è”¬èœ'}}">ğŸ¥—</text>
            <text wx:elif="{{food.category === 'æ°´æœ'}}">ğŸ</text>
            <text wx:elif="{{food.category === 'é¥®å“'}}">ğŸ¥¤</text>
            <text wx:elif="{{food.category === 'é›¶é£Ÿ'}}">ğŸª</text>
            <text wx:else>ğŸ½ï¸</text>
          </view>
        </view>
        <!-- åˆ»åº¦æ ‡è®° -->
        <view class="slider-marks">
          <text class="mark">10g</text>
          <text class="mark">250g</text>
          <text class="mark">500g</text>
        </view>
      </view>

      <!-- å¿«æ·ä»½é‡æŒ‰é’® -->
      <view class="quick-amounts">
        <view wx:for="{{quickAmounts}}" wx:key="*this"
              class="quick-amount {{amount === item ? 'active' : ''}}"
              bindtap="setQuickAmount" data-amount="{{item}}">
          {{item}}g
        </view>
      </view>

      <!-- ç²¾ç¡®è°ƒæ•´ -->
      <view class="fine-adjust">
        <view class="adjust-btn minus" bindtap="adjustAmount" data-delta="{{-5}}">
          <text>-5</text>
        </view>
        <view class="adjust-btn minus-small" bindtap="adjustAmount" data-delta="{{-1}}">
          <text>-1</text>
        </view>
        <view class="current-amount">
          <input class="amount-input-field"
                 type="number"
                 value="{{amount}}"
                 bindinput="onAmountInput" />
          <text class="g-label">g</text>
        </view>
        <view class="adjust-btn plus-small" bindtap="adjustAmount" data-delta="{{1}}">
          <text>+1</text>
        </view>
        <view class="adjust-btn plus" bindtap="adjustAmount" data-delta="{{5}}">
          <text>+5</text>
        </view>
      </view>
    </view>

    <!-- é¤æ¬¡é€‰æ‹© -->
    <view class="meal-card">
      <view class="meal-header">
        <text class="meal-label">æ·»åŠ åˆ°</text>
        <view class="meal-btn" bindtap="toggleMealTypeSelector">
          <text>{{mealTypeLabels[selectedMealType]}}</text>
          <text class="arrow">{{showMealTypeSelector ? 'â–²' : 'â–¼'}}</text>
        </view>
      </view>
      <view wx:if="{{showMealTypeSelector}}" class="meal-options">
        <view wx:for="{{['breakfast', 'lunch', 'dinner', 'snack']}}" wx:key="*this"
              class="meal-option {{selectedMealType === item ? 'active' : ''}}"
              bindtap="selectMealType" data-type="{{item}}">
          {{mealTypeLabels[item]}}
        </view>
      </view>
    </view>

    <!-- è®¡ç®—ç»“æœ -->
    <view class="result-card">
      <view class="result-header">
        <text class="result-label">æœ¬æ¬¡æ‘„å…¥</text>
      </view>
      <view class="result-calories">
        <text class="result-value">{{calculatedNutrition.calories}}</text>
        <text class="result-unit">kcal</text>
      </view>
      <view class="result-macros">
        <view class="result-macro">
          <text class="macro-icon">ğŸ¥©</text>
          <text class="macro-value">{{calculatedNutrition.protein}}g</text>
          <text class="macro-name">è›‹ç™½è´¨</text>
        </view>
        <view class="result-macro">
          <text class="macro-icon">ğŸŒ¾</text>
          <text class="macro-value">{{calculatedNutrition.carbs}}g</text>
          <text class="macro-name">ç¢³æ°´</text>
        </view>
        <view class="result-macro">
          <text class="macro-icon">ğŸ’§</text>
          <text class="macro-value">{{calculatedNutrition.fat}}g</text>
          <text class="macro-name">è„‚è‚ª</text>
        </view>
      </view>
    </view>

    <!-- æäº¤æŒ‰é’® -->
    <button class="submit-btn" bindtap="submit" disabled="{{isSubmitting || !name}}">
      <text wx:if="{{isSubmitting}}">ä¿å­˜ä¸­...</text>
      <text wx:else>âœ“ ç¡®è®¤æ·»åŠ </text>
    </button>
  </view>
</view>

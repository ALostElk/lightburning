<!--
  é£Ÿç‰©æœç´¢é¡µé¢ - diet-search/index
  åŠŸèƒ½ï¼šæœç´¢é£Ÿç‰© + æˆ‘çš„å¸¸ç”¨
-->
<view class="page">
  <!-- èƒŒæ™¯è£…é¥° -->
  <view class="page-bg"></view>

  <!-- æœç´¢å¤´éƒ¨ -->
  <view class="search-header">
    <view class="back-btn" bindtap="goBack">
      <text>â†</text>
    </view>
    <view class="search-input-wrapper">
      <text class="search-icon">ğŸ”</text>
      <input class="search-input"
             value="{{keyword}}"
             placeholder="æœç´¢é£Ÿç‰©..."
             bindinput="onInput"
             confirm-type="search"
             bindconfirm="fullSearch"
             bindfocus="onSearchFocus" />
      <view wx:if="{{keyword}}" class="clear-btn" bindtap="clearInput">
        <text>âœ•</text>
      </view>
    </view>
  </view>

  <!-- é¤æ¬¡æç¤º -->
  <view class="meal-hint">
    <text>æ·»åŠ åˆ°: </text>
    <text class="meal-name">{{mealTypeLabels[selectedMealType]}}</text>
    <text wx:if="{{searchSource}}" class="source-hint">Â· {{searchSource}}</text>
  </view>

  <!-- æ ‡ç­¾åˆ‡æ¢ -->
  <view class="tabs-wrapper">
    <view class="tabs-container">
      <view
        class="tab-item {{activeTab === 'search' ? 'active' : ''}}"
        bindtap="switchTab"
        data-tab="search"
      >
        <text class="tab-icon">ğŸ”</text>
        <text>æœç´¢</text>
      </view>
      <view
        class="tab-item {{activeTab === 'favorites' ? 'active' : ''}}"
        bindtap="switchTab"
        data-tab="favorites"
      >
        <text class="tab-icon">â¤ï¸</text>
        <text>æˆ‘çš„å¸¸ç”¨</text>
        <view wx:if="{{frequentFoods.length > 0}}" class="tab-badge">{{frequentFoods.length}}</view>
      </view>
    </view>
  </view>

  <view class="content">
    <!-- ============ æœç´¢æ ‡ç­¾å†…å®¹ ============ -->
    <view wx:if="{{activeTab === 'search'}}">
      <!-- é”™è¯¯æç¤º -->
      <view wx:if="{{error}}" class="error-box">
        <text class="error-icon">âš ï¸</text>
        <text class="error-text">{{error}}</text>
      </view>

      <!-- åŠ è½½çŠ¶æ€ -->
      <view wx:if="{{isSearching || isDeepSearching}}" class="loading-box">
        <view class="loading-spinner"></view>
        <text class="loading-text">{{isDeepSearching ? 'æ·±åº¦æœç´¢ä¸­...' : 'æœç´¢ä¸­...'}}</text>
      </view>

      <!-- æœ€è¿‘æœç´¢ -->
      <view wx:if="{{!keyword && recentSearches.length > 0}}" class="recent-section">
        <view class="section-header">
          <view class="section-title">
            <text class="section-icon">ğŸ•</text>
            <text>æœ€è¿‘æœç´¢</text>
          </view>
          <view class="clear-link" bindtap="clearRecentSearches">æ¸…ç©º</view>
        </view>
        <view class="recent-tags">
          <view wx:for="{{recentSearches}}" wx:key="*this" class="recent-tag" bindtap="useRecentSearch" data-term="{{item}}">
            {{item}}
          </view>
        </view>
      </view>

      <!-- ç”¨æˆ·èœå“ -->
      <view wx:if="{{userDishes.length > 0}}" class="results-section">
        <view class="section-title-simple">æˆ‘çš„èœå“</view>
        <view class="food-list">
          <view wx:for="{{userDishes}}" wx:key="_id" class="food-card user-dish" bindtap="selectFood" data-food="{{item}}">
            <view class="food-emoji">ğŸ½ï¸</view>
            <view class="food-info">
              <text class="food-name">{{item.name}}</text>
              <text class="food-meta">{{item.calories}} kcal Â· è‡ªå®šä¹‰èœå“</text>
            </view>
          </view>
        </view>
      </view>

      <!-- æœç´¢ç»“æœ -->
      <view wx:if="{{results.length > 0}}" class="results-section">
        <view class="section-title-simple">æœç´¢ç»“æœ</view>
        <view class="food-list">
          <view wx:for="{{results}}" wx:key="_id" class="food-card" bindtap="selectFood" data-food="{{item}}">
            <view class="food-emoji">
              <text wx:if="{{item.category === 'ä¸»é£Ÿ'}}">ğŸš</text>
              <text wx:elif="{{item.category === 'è‚‰ç±»'}}">ğŸ¥©</text>
              <text wx:elif="{{item.category === 'è›‹å¥¶'}}">ğŸ¥š</text>
              <text wx:elif="{{item.category === 'è”¬èœ'}}">ğŸ¥—</text>
              <text wx:elif="{{item.category === 'æ°´æœ'}}">ğŸ</text>
              <text wx:else>ğŸ½ï¸</text>
            </view>
            <view class="food-info">
              <view class="food-name-row">
                <text class="food-name">{{item.name}}</text>
                <text wx:if="{{item.source === 'builtin'}}" class="source-badge green">å†…ç½®</text>
                <text wx:elif="{{item.source === 'ai_estimated'}}" class="source-badge purple">AI</text>
                <text wx:elif="{{item.source === 'open_food_facts'}}" class="source-badge blue">OFF</text>
              </view>
              <text class="food-meta">{{item.category || 'æœªåˆ†ç±»'}} Â· æ¯100g {{item.calories}} kcal</text>
              <view class="food-macros">
                <text class="macro protein">è›‹ç™½ {{item.protein}}g</text>
                <text class="macro carbs">ç¢³æ°´ {{item.carbs}}g</text>
                <text class="macro fat">è„‚è‚ª {{item.fat}}g</text>
              </view>
            </view>
            <view class="food-calories">
              <text class="cal-value">{{item.calories}}</text>
              <text class="cal-unit">kcal</text>
            </view>
          </view>
        </view>
      </view>

      <!-- æ·±åº¦æœç´¢æŒ‰é’® -->
      <view wx:if="{{hasMore && keyword && !isDeepSearching}}" class="deep-search-btn" bindtap="fullSearch">
        <text class="btn-icon">âœ¨</text>
        <text>AI æ·±åº¦æœç´¢</text>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view wx:if="{{keyword && !isSearching && !isDeepSearching && results.length === 0 && userDishes.length === 0}}" class="empty-state">
        <view class="empty-icon">ğŸ”</view>
        <view class="empty-title">æœªæ‰¾åˆ°ç›¸å…³é£Ÿç‰©</view>
        <view class="empty-desc">å°è¯•æ¢ä¸ªå…³é”®è¯ï¼Œæˆ–ä½¿ç”¨ AI æ·±åº¦æœç´¢</view>
        <view class="deep-search-btn" bindtap="fullSearch">
          <text>AI æ·±åº¦æœç´¢</text>
        </view>
      </view>

      <!-- æ‰‹åŠ¨è¾“å…¥é“¾æ¥ -->
      <view class="manual-link" bindtap="goToManual">
        <text>æ‰¾ä¸åˆ°ï¼Ÿ</text>
        <text class="link-text">æ‰‹åŠ¨è¾“å…¥</text>
      </view>
    </view>

    <!-- ============ æˆ‘çš„å¸¸ç”¨æ ‡ç­¾å†…å®¹ ============ -->
    <view wx:if="{{activeTab === 'favorites'}}" class="favorites-content">
      <!-- é¤æ¬¡å­æ ‡ç­¾ -->
      <view class="meal-filter">
        <view
          class="meal-filter-item {{favoriteMealFilter === 'all' ? 'active' : ''}}"
          bindtap="switchFavoriteMeal"
          data-meal="all"
        >å…¨éƒ¨</view>
        <view
          class="meal-filter-item {{favoriteMealFilter === 'breakfast' ? 'active' : ''}}"
          bindtap="switchFavoriteMeal"
          data-meal="breakfast"
        >æ—©é¤</view>
        <view
          class="meal-filter-item {{favoriteMealFilter === 'lunch' ? 'active' : ''}}"
          bindtap="switchFavoriteMeal"
          data-meal="lunch"
        >åˆé¤</view>
        <view
          class="meal-filter-item {{favoriteMealFilter === 'dinner' ? 'active' : ''}}"
          bindtap="switchFavoriteMeal"
          data-meal="dinner"
        >æ™šé¤</view>
        <view
          class="meal-filter-item {{favoriteMealFilter === 'snack' ? 'active' : ''}}"
          bindtap="switchFavoriteMeal"
          data-meal="snack"
        >åŠ é¤</view>
      </view>

      <!-- åŠ è½½çŠ¶æ€ -->
      <view wx:if="{{isLoadingFavorites}}" class="loading-box">
        <view class="loading-spinner"></view>
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>

      <!-- å¸¸ç”¨é£Ÿç‰©ç½‘æ ¼ -->
      <view wx:elif="{{frequentFoods.length > 0}}" class="favorites-grid">
        <view
          wx:for="{{frequentFoods}}"
          wx:key="_id"
          class="favorite-card"
          bindtap="selectFavorite"
          data-food="{{item}}"
        >
          <!-- é£Ÿç‰©å›¾ç‰‡/å›¾æ ‡ -->
          <view class="favorite-avatar">
            <text class="favorite-emoji">{{item.emoji || 'ğŸ½ï¸'}}</text>
          </view>

          <!-- é£Ÿç‰©ä¿¡æ¯ -->
          <view class="favorite-info">
            <text class="favorite-name">{{item.name}}</text>
            <text class="favorite-calories">{{item.calories}} Kcal</text>
          </view>

          <!-- ä½¿ç”¨æ¬¡æ•°æ ‡è®° -->
          <view class="favorite-count" wx:if="{{item.useCount > 1}}">
            <text>Ã—{{item.useCount}}</text>
          </view>

          <!-- æ·»åŠ å›¾æ ‡ -->
          <view class="favorite-add-icon">
            <text>+</text>
          </view>
        </view>

        <!-- æ‰‹åŠ¨æ·»åŠ å¡ç‰‡ -->
        <view class="favorite-card add-card" bindtap="goToManual">
          <view class="add-card-icon">
            <text>âœï¸</text>
          </view>
          <view class="favorite-info">
            <text class="favorite-name">æ‰‹åŠ¨æ·»åŠ </text>
            <text class="favorite-calories">æ·»åŠ åˆ°{{mealTypeLabels[selectedMealType]}}</text>
          </view>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view wx:else class="favorites-empty">
        <view class="empty-heart">â¤ï¸</view>
        <view class="empty-title">è¿˜æ²¡æœ‰å¸¸ç”¨é£Ÿç‰©</view>
        <view class="empty-desc">è®°å½•çš„é£Ÿç‰©ä¼šè‡ªåŠ¨æ·»åŠ åˆ°è¿™é‡Œ</view>
        <view class="empty-tips">
          <view class="tip-item">
            <text class="tip-icon">ğŸ’¡</text>
            <text>å¸¸åƒçš„é£Ÿç‰©ä¼šè‡ªåŠ¨æ’åœ¨å‰é¢</text>
          </view>
          <view class="tip-item">
            <text class="tip-icon">âš¡</text>
            <text>ç‚¹å‡»å³å¯å¿«é€Ÿæ·»åŠ </text>
          </view>
        </view>
        <view class="start-search-btn" bindtap="switchToSearch">
          <text>å»æœç´¢é£Ÿç‰©</text>
        </view>
      </view>

      <!-- åº•éƒ¨æç¤º -->
      <view wx:if="{{frequentFoods.length > 0}}" class="favorites-footer">
        <text class="footer-hint">ç‚¹å‡»å¡ç‰‡å¿«é€Ÿæ·»åŠ åˆ° {{mealTypeLabels[selectedMealType]}}</text>
      </view>
    </view>
  </view>
</view>
